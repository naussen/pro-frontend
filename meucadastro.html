<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Pagamento de Assinatura - PRO Concursos</title>
  <style>
    :root {
      --header-height: 55px;
      --main-color: #1A5276;
      --light-highlight-bg: #EAF2F8;
      --accent-1: #D4AC0D;
      --accent-1-darker: #b3910b;
      --accent-2: #CA6F1E;
      --dark-bg: #154360;
      --subnav-bg: #282A35;
      --text-dark: #333;
      --text-light: #f8f9fa;
      --text-muted: #6c757d;
      --border-color: #ccc;
      --light-grey-bg: #f1f1f1;
      --header-bg: #ffffff;
      --header-border: #e7e7e7;
      --main-content-bg: #ffffff;
      --code-bg: #f1f1f1;
      --button-text-dark: #333;
      --footer-text-muted: #ccc;
      --footer-link-color: #ccc;
      --footer-link-hover: var(--accent-1);
      --footer-separator: #555;
      --footer-h4: #f1f1f1;
      --dark-blue-hover: #113a54;
      --error-color: #D32F2F;
      --success-color: #2ecc71;
    }

    body.dark-mode {
      --main-color: #6cb6ff;
      --light-highlight-bg: #2d333b;
      --accent-1: #e4c05c;
      --accent-1-darker: #cfae51;
      --accent-2: #d98234;
      --dark-bg: #0d1117;
      --subnav-bg: #22272e;
      --text-dark: #c9d1d9;
      --text-light: #f0f6fc;
      --text-muted: #8b949e;
      --border-color: #444c56;
      --light-grey-bg: #0d1117;
      --header-bg: #161b22;
      --header-border: #30363d;
      --main-content-bg: #161b22;
      --code-bg: #22272e;
      --button-text-dark: #161b22;
      --footer-text-muted: #8b949e;
      --footer-link-color: #8b949e;
      --footer-link-hover: var(--accent-1);
      --footer-separator: #30363d;
      --footer-h4: var(--text-light);
      --dark-blue-hover: #1a6fba;
      --error-color: #FF5252;
      --success-color: #27ae60;
    }

    html { height: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: var(--light-grey-bg);
      color: var(--text-dark);
      padding-top: var(--header-height);
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .w3s-header {
      background-color: var(--header-bg);
      color: var(--text-dark);
      display: flex;
      align-items: center;
      padding: 0 20px;
      height: var(--header-height);
      width: 100%;
      box-sizing: border-box;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 103;
      border-bottom: 1px solid var(--header-border);
      gap: 15px;
    }
    .w3s-logo-area {
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }
    .w3s-logo-placeholder {
      width: 35px;
      height: 35px;
      margin-right: 8px;
    }
    .w3s-logo-placeholder text {
      font-size: 35px;
      fill: var(--main-color);
      font-weight: bold;
      font-family: sans-serif;
    }
    .w3s-logo-placeholder circle {
      fill: transparent;
      stroke: var(--main-color);
      stroke-width: 5;
    }
    .w3s-header-right-group {
      display: flex;
      align-items: center;
      margin-left: auto;
      gap: 12px;
    }
    .w3s-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      position: relative;
    }
    .w3s-header-actions a,
    .w3s-header-actions button {
      color: var(--text-dark);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: color 0.2s, background-color 0.2s;
      padding: 5px 6px;
      border-radius: 4px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .w3s-header-actions a .icon,
    .w3s-header-actions button .icon {
      font-size: 1.1em;
      display: inline-block;
      width: 1em;
      height: 1em;
      line-height: 1em;
      text-align: center;
      color: #666;
    }
    body.dark-mode .w3s-header-actions a,
    body.dark-mode .w3s-header-actions button {
      color: var(--text-muted);
    }
    body.dark-mode .w3s-header-actions a .icon,
    body.dark-mode .w3s-header-actions button .icon {
      color: var(--text-muted);
    }
    .w3s-header-actions a[title="Contato"] .icon {
      color: var(--main-color);
    }
    .w3s-header-actions a[title="Logout"] .icon {
      color: #f78166;
    }
    .w3s-header-actions a:hover,
    .w3s-header-actions button:hover {
      color: var(--main-color);
      background-color: rgba(0,0,0,0.03);
    }
    body.dark-mode .w3s-header-actions a:hover,
    body.dark-mode .w3s-header-actions button:hover {
      background-color: rgba(255,255,255,0.05);
    }
    .w3s-header-actions a:hover .icon,
    .w3s-header-actions button:hover .icon {
      color: var(--main-color);
    }
    #theme-toggle .icon {
      font-size: 1.3em;
    }

    main {
      flex-grow: 1;
      background-color: var(--main-content-bg);
      width: 100%;
      box-sizing: border-box;
      padding: 30px 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .payment-section {
      background-color: var(--header-bg);
      padding: 30px 40px;
      border-radius: 8px;
      border: 1px solid var(--header-border);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    .payment-section h2 {
      font-size: 1.8em;
      color: var(--main-color);
      margin-top: 0;
      margin-bottom: 20px;
    }
    .payment-section .plan-details {
      font-size: 1.2em;
      margin-bottom: 20px;
      color: var(--text-dark);
    }
    .payment-section .plan-details .price {
      font-weight: bold;
      color: var(--accent-1-darker);
      font-size: 1.5em;
    }
    .payment-options {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .payment-button {
      display: inline-block;
      padding: 12px 20px;
      background-color: var(--main-color);
      color: var(--text-light);
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      text-align: center;
      text-decoration: none;
    }
    body.dark-mode .payment-button {
      color: var(--button-text-dark);
    }
    .payment-button:hover {
      background-color: var(--dark-blue-hover);
      transform: translateY(-2px);
    }
    .payment-button.mercado-pago {
      background-color: #009ee3;
    }
    .payment-button.mercado-pago:hover {
      background-color: #0080c1;
    }
    .payment-button.paypal {
      background-color: #ffc107;
      color: #003087;
    }
    .payment-button.paypal:hover {
      background-color: #e0a800;
    }
    .security-note {
      margin-top: 20px;
      font-size: 0.9em;
      color: var(--text-muted);
    }
    .security-note i {
      margin-right: 5px;
      color: var(--success-color);
    }
    .error-message {
      color: var(--error-color);
      font-size: 1em;
      margin-top: 20px;
      display: none;
    }
    .cookie-warning {
      color: var(--error-color);
      font-size: 0.9em;
      margin-top: 10px;
      display: none;
    }
    .cookie-warning a {
      color: var(--main-color);
      text-decoration: none;
    }
    .cookie-warning a:hover {
      text-decoration: underline;
    }
    .success-message {
      color: var(--success-color);
      font-size: 1.2em;
      margin-top: 20px;
      display: none;
      font-weight: bold;
    }
    .success-message a {
      color: var(--main-color);
      text-decoration: none;
      font-weight: bold;
    }
    .success-message a:hover {
      text-decoration: underline;
    }

    .footer {
      background-color: var(--dark-bg);
      color: var(--footer-text-muted);
      padding: 30px 20px;
      text-align: left;
      width: 100%;
      box-sizing: border-box;
      z-index: 101;
      flex-shrink: 0;
      margin-top: 40px;
    }
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--footer-separator);
      margin-bottom: 15px;
    }
    .footer-section {
      min-width: 200px;
      flex-grow: 1;
    }
    .footer h4 {
      color: var(--footer-h4);
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--footer-separator);
      padding-bottom: 8px;
      font-size: 1.1em;
    }
    .footer ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer ul li {
      margin-bottom: 8px;
    }
    .footer ul li a,
    .footer-section p a {
      color: var(--footer-link-color);
      text-decoration: none;
      font-size: 0.9em;
      transition: color 0.3s;
    }
    .footer ul li a:hover,
    .footer-section p a:hover {
      color: var(--footer-link-hover);
    }
    .footer-section p {
      color: var(--footer-link-color);
      font-size: 0.9em;
      margin: 0 0 8px 0;
      line-height: 1.5;
    }
    .footer-copyright {
      text-align: center;
      font-size: 0.85em;
      color: #a8c0d1;
      width: 100%;
      padding-top: 15px;
    }
    body.dark-mode .footer-copyright {
      color: var(--text-muted);
    }
    .footer-copyright a {
      color: var(--footer-link-color);
    }
    .footer-copyright a:hover {
      color: var(--footer-link-hover);
    }

    @media screen and (max-width: 992px) {
      .w3s-header-right-group {
        gap: 10px;
      }
      .w3s-header-actions {
        gap: 8px;
      }
      .w3s-header-actions a span.link-text {
        display: none;
      }
      .w3s-header {
        gap: 10px;
        padding: 0 10px;
      }
      .container {
        max-width: 95%;
      }
    }
    @media screen and (max-width: 768px) {
      .w3s-header {
        height: 50px;
      }
      body {
        padding-top: 50px;
      }
      main {
        padding: 20px 0;
      }
      .container {
        padding: 0 15px;
      }
      .payment-section {
        padding: 20px;
      }
      .payment-section h2 {
        font-size: 1.6em;
      }
      .payment-options {
        flex-direction: column;
        gap: 15px;
      }
      .payment-button {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }
      .footer-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .footer-section {
        min-width: unset;
        width: 80%;
        margin-bottom: 15px;
      }
    }
    @media screen and (max-width: 480px) {
      .payment-section .plan-details {
        font-size: 1em;
      }
      .payment-section .plan-details .price {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>

<header class="w3s-header" id="mainHeader">
  <div class="w3s-logo-area">
    <a href="index.html" title="Página Inicial">
      <svg class="w3s-logo-placeholder" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="48"/>
        <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle">NVP</text>
      </svg>
    </a>
  </div>
  <div class="w3s-header-right-group">
    <div class="w3s-header-actions">
      <button id="theme-toggle" title="Alternar Tema Claro/Escuro">
        <span class="icon theme-icon-light">☀️</span>
        <span class="icon theme-icon-dark" style="display: none;">🌙</span>
      </button>
      <a href="#" title="Contato"><span class="icon">👨‍🏫</span> <span class="link-text">Contato</span></a>
      <button id="logout-btn" title="Logout"><span class="icon">🚪</span> <span class="link-text">Logout</span></button>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <section class="payment-section">
      <h2>Finalizar Assinatura</h2>
      <div class="plan-details">
        Plano Mensal: <span class="price">R$ 29,90/mês</span><br>
        <small>Cancele quando quiser</small>
      </div>
      <div class="payment-options">
        <!-- Botão Mercado Pago -->
        <a href="#" id="mercado-pago-btn" class="payment-button mercado-pago">Pagar com Mercado Pago</a>
        <!-- Botão PayPal -->
        <div id="paypal-button-container"></div>
      </div>
      <div class="cookie-warning" id="paypal-cookie-warning">
        O PayPal requer cookies de terceiros. <a href="https://support.google.com/chrome/answer/95647" target="_blank">Saiba como ativar</a> ou use o Mercado Pago.
      </div>
      <div class="security-note">
        <i>🔒</i> Pagamento seguro com Mercado Pago e PayPal
      </div>
      <div id="error-message" class="error-message">
        Ocorreu um erro ao processar o pagamento. Tente novamente.
      </div>
      <div id="success-message" class="success-message">
        Assinatura confirmada! Bem-vindo(a) ao NVP Concursos!<br>
        <a href="guia.html">Conheça o Guia Inicial</a>
      </div>
    </section>
  </div>
</main>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-section">
      <h4>Recursos Adicionais</h4>
      <ul>
        <li><a href="#">Questões Comentadas</a></li>
        <li><a href="#">Mapas Mentais</a></li>
        <li><a href="#">Legislação Compilada</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h4>Próximos Módulos</h4>
      <p><a href="#">Direito Administrativo</a></p>
      <p><a href="#">Português para Concursos</a></p>
    </div>
    <div class="footer-section">
      <h4>Links Úteis</h4>
      <ul>
        <li><a href="#">Termos de Uso</a></li>
        <li><a href="#">Política de Privacidade</a></li>
        <li><a href="#">Sobre Nós</a></li>
        <li><a href="#">Mapa do Site</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-copyright">
    <span>© <span id="current-year"></span> NVP Concursos. Todos os direitos reservados.</span>
  </div>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<!-- Mercado Pago SDK -->
<script src="https://sdk.mercadopago.com/js/v2"></script>
<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AcwJztgY_UReyUkD_Yw2Yr...&vault=true&intent=subscription"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBSRxfHTLbNJWIz2k6ndi1yfVPRq9jzGq8",
    authDomain: "nvp-concursos.firebaseapp.com",
    projectId: "nvp-concursos",
    storageBucket: "nvp-concursos.firebasestorage.app",
    messagingSenderId: "397960760271",
    appId: "1:397960760271:web:1243b04141178453d860ba"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const themeToggleBtn = document.getElementById('theme-toggle');
  const bodyElement = document.body;
  const sunIcon = themeToggleBtn?.querySelector('.theme-icon-light');
  const moonIcon = themeToggleBtn?.querySelector('.theme-icon-dark');

  function applyTheme(theme) {
    if (theme === 'dark') {
      bodyElement.classList.add('dark-mode');
      if (sunIcon) sunIcon.style.display = 'none';
      if (moonIcon) moonIcon.style.display = 'inline';
    } else {
      bodyElement.classList.remove('dark-mode');
      if (sunIcon) sunIcon.style.display = 'inline';
      if (moonIcon) moonIcon.style.display = 'none';
    }
  }

  const savedTheme = localStorage.getItem('theme');
  const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
  let currentTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
  applyTheme(currentTheme);

  if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', () => {
      let newTheme = bodyElement.classList.contains('dark-mode') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });
  }

  prefersDarkScheme.addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });

  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      }).catch(error => {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao tentar sair. Tente novamente.');
      });
    });
  }

  function showSuccessMessage() {
    document.getElementById('success-message').style.display = 'block';
    document.querySelector('.payment-options').style.display = 'none';
    document.querySelector('.security-note').style.display = 'none';
    setTimeout(() => {
      window.location.href = 'guia.html';
    }, 3000);
  }

  // Verifica se o usuário está logado
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'index.html';
    } else {
      initializePayment(user);
    }
  });

  function initializePayment(user) {
    // Mercado Pago
    const mp = new MercadoPago('YOUR_MERCADO_PAGO_PUBLIC_KEY', {
      locale: 'pt-BR'
    });

    const mercadoPagoBtn = document.getElementById('mercado-pago-btn');
    mercadoPagoBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        // Simulação de criação de preferência (deve ser feita no backend em produção)
        const preference = {
          items: [
            {
              title: 'Assinatura Mensal NVP Concursos',
              unit_price: 29.90,
              quantity: 1,
            }
          ],
          auto_recurring: {
            frequency: 1,
            frequency_type: 'months',
            transaction_amount: 29.90,
            currency_id: 'BRL'
          },
          back_urls: {
            success: window.location.origin + '/pagamento.html?status=success',
            failure: window.location.origin + '/pagamento.html?status=failure',
            pending: window.location.origin + '/pagamento.html?status=pending'
          },
          payer: {
            email: user.email
          }
        };

        // Em produção, isso deve ser feito no backend com o Access Token
        const response = await fetch('https://api.mercadopago.com/checkout/preferences', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer YOUR_MERCADO_PAGO_ACCESS_TOKEN',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(preference)
        });
        const data = await response.json();
        window.location.href = data.init_point;
      } catch (error) {
        console.error('Erro ao criar preferência Mercado Pago:', error);
        document.getElementById('error-message').style.display = 'block';
      }
    });

    // Verifica se cookies de terceiros estão bloqueados
    function areThirdPartyCookiesBlocked() {
      // Testa se cookies de terceiros estão bloqueados criando um iframe e tentando acessar um cookie
      return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'https://www.paypal.com';
        document.body.appendChild(iframe);

        setTimeout(() => {
          try {
            iframe.contentWindow.document.cookie;
            resolve(false); // Cookies de terceiros estão habilitados
          } catch (e) {
            resolve(true); // Cookies de terceiros estão bloqueados
          } finally {
            document.body.removeChild(iframe);
          }
        }, 1000);
      });
    }

    // Inicializa o PayPal
    areThirdPartyCookiesBlocked().then(blocked => {
      if (blocked) {
        document.getElementById('paypal-cookie-warning').style.display = 'block';
        document.getElementById('paypal-button-container').innerHTML = '<a href="#" class="payment-button paypal">Pagar com PayPal (indisponível)</a>';
      } else {
        paypal.Buttons({
          createSubscription: (data, actions) => {
            return actions.subscription.create({
              plan_id: 'YOUR_PAYPAL_PLAN_ID',
              custom_id: user.uid
            });
          },
          onApprove: async (data, actions) => {
            try {
              await db.collection('users').doc(user.uid).update({
                is_subscriber: true,
                subscription_id: data.subscriptionID,
                subscription_start: firebase.firestore.FieldValue.serverTimestamp()
              });
              showSuccessMessage();
            } catch (error) {
              console.error('Erro ao atualizar status de assinatura:', error);
              document.getElementById('error-message').style.display = 'block';
            }
          },
          onError: (err) => {
            console.error('Erro no PayPal:', err);
            document.getElementById('error-message').style.display = 'block';
          }
        }).render('#paypal-button-container');
      }
    });

    // Verifica o status de retorno do Mercado Pago
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    if (status === 'success') {
      db.collection('users').doc(user.uid).update({
        is_subscriber: true,
        subscription_start: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        showSuccessMessage();
      }).catch(error => {
        console.error('Erro ao atualizar status de assinatura:', error);
        document.getElementById('error-message').style.display = 'block';
      });
    } else if (status === 'failure' || status === 'pending') {
      document.getElementById('error-message').style.display = 'block';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const yearSpan = document.getElementById('current-year');
    if (yearSpan) yearSpan.textContent = new Date().getFullYear();
  });
</script>

</body>
</html>