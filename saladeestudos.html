<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Sala de Estudos - NVP Concursos</title>
    <?php // wp_head(); ?>
    <style>
      /* === CSS CONSOLIDADO === */
      :root {
        --header-height: 55px;
        --subnav-height: 35px;
        --total-header-height: calc(var(--header-height) + var(--subnav-height));
        --sidenav-width: 250px;
        --sidenav-width-mobile: 220px;

        /* Paleta de Cores CLARA (Padr√£o) - Ajustada para Melhor Legibilidade */
        --main-color: #1A5276;
        --light-highlight-bg: #EAF2F8;
        --accent-1: #D4AC0D;
        --accent-1-darker: #b3910b;
        --accent-2: #CA6F1E;
        --dark-bg: #154360;
        --subnav-bg: #2F2F2F;
        --text-dark: #1a1a1a; /* Ajustado para maior contraste no modo claro */
        --text-light: #ffffff;
        --text-muted: #555; /* Ajustado para maior contraste no modo claro */
        --border-color: #ddd;
        --light-grey-bg: #f5f5f5;
        --header-bg: #ffffff;
        --header-border: #e0e0e0;
        --main-content-bg: #ffffff;
        --code-bg: #f4f4f4;
        --button-text-dark: #1a1a1a; /* Ajustado para consist√™ncia */
        --footer-text-muted: #aaa;
        --footer-link-color: #aaa;
        --footer-link-hover: var(--accent-1);
        --footer-separator: #444;
        --footer-h4: #e0e0e0;
        --dark-blue-hover: #113a54;
        --error-color: #D32F2F;
      }

      /* Estilos Base para Modo Escuro */
      body.dark-mode {
        --main-color: #6cb6ff;
        --light-highlight-bg: #2d333b;
        --accent-1: #e4c05c;
        --accent-1-darker: #cfae51;
        --accent-2: #d98234;
        --dark-bg: #0d1117;
        --subnav-bg: #22272e;
        --text-dark: #c9d1d9;
        --text-light: #f0f6fc;
        --text-muted: #8b949e;
        --border-color: #444c56;
        --light-grey-bg: #0d1117;
        --header-bg: #161b22;
        --header-border: #30363d;
        --main-content-bg: #161b22;
        --code-bg: #22272e;
        --button-text-dark: #161b22;
        --footer-text-muted: #8b949e;
        --footer-link-color: #8b949e;
        --footer-link-hover: var(--accent-1);
        --footer-separator: #30363d;
        --footer-h4: var(--text-light);
        --dark-blue-hover: #1a6fba;
        --error-color: #FF5252;
      }

      /* Estilos Gerais */
      html { height: 100%; scroll-behavior: smooth; }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        display: flex; flex-direction: column; min-height: 100vh;
        background-color: var(--light-grey-bg); color: var(--text-dark);
        padding-top: var(--total-header-height); box-sizing: border-box;
        transition: background-color 0.3s ease, color 0.3s ease;
        line-height: 1.6; /* Melhor legibilidade */
        font-size: 16px; /* Tamanho base para melhor leitura */
      }
      body.sidenav-open-mobile { overflow: hidden; }

      /* Cabe√ßalho */
      .w3s-header {
        background-color: var(--header-bg); color: var(--text-dark); display: flex; align-items: center;
        padding: 0 20px; height: var(--header-height); width: 100%;
        box-sizing: border-box; position: fixed; top: 0; left: 0;
        z-index: 103; border-bottom: 1px solid var(--header-border); gap: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .w3s-logo-area { display: flex; align-items: center; flex-shrink: 0; }
      .w3s-logo-placeholder { width: 35px; height: 35px; margin-right: 8px; }
      .w3s-logo-placeholder text { fill: var(--main-color); font-weight: bold; font-family: sans-serif; font-size: 35px;}
      .w3s-logo-placeholder circle { fill: transparent; stroke: var(--main-color); stroke-width: 5; }
      .w3s-header-right-group { display: flex; align-items: center; margin-left: auto; gap: 12px; }
      .w3s-header-actions { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
      .w3s-header-actions a, .w3s-header-actions button {
        color: var(--text-dark); text-decoration: none; font-size: 14px;
        display: flex; align-items: center; gap: 5px; transition: color 0.2s, background-color 0.2s;
        padding: 8px 12px; border-radius: 4px; background: none; border: none; cursor: pointer;
      }
      .w3s-header-actions a .icon, .w3s-header-actions button .icon {
        font-size: 1.2em; display: inline-block; width: 1em; height: 1em;
        line-height: 1em; text-align: center; color: var(--text-muted);
      }
      body.dark-mode .w3s-header-actions a, body.dark-mode .w3s-header-actions button { color: var(--text-muted); }
      body.dark-mode .w3s-header-actions a .icon, body.dark-mode .w3s-header-actions button .icon { color: var(--text-muted); }
      .w3s-header-actions a[title="Meu Cadastro"] .icon { color: #58a6ff; }
      .w3s-header-actions a[title="Personalizar Sala de Estudos"] .icon { color: #3fb950; }
      .w3s-header-actions button[title="Logout"] .icon { color: #f78166; }
      .w3s-header-actions a:hover, .w3s-header-actions button:hover {
        color: var(--main-color); background-color: rgba(0,0,0,0.05);
      }
      body.dark-mode .w3s-header-actions a:hover, body.dark-mode .w3s-header-actions button:hover {
        background-color: rgba(255,255,255,0.05);
      }
      .w3s-header-actions a:hover .icon, .w3s-header-actions button:hover .icon {
        color: var(--main-color);
      }
      #theme-toggle {
        background: none; border: none; cursor: pointer; padding: 5px;
        display: flex; align-items: center; color: var(--text-muted);
      }
      #theme-toggle:hover { color: var(--main-color); }
      #theme-toggle .icon { font-size: 1.5em; }
      body:not(.dark-mode) #theme-toggle .theme-icon-dark { display: none; }
      body:not(.dark-mode) #theme-toggle .theme-icon-light { display: inline; }
      body.dark-mode #theme-toggle .theme-icon-dark { display: inline; }
      body.dark-mode #theme-toggle .theme-icon-light { display: none; }

      /* Sub-Topnav (Cursos) */
      .sub-topnav {
        height: var(--subnav-height); background-color: var(--subnav-bg); width: 100%;
        position: fixed; top: var(--header-height); left: 0; z-index: 102;
        display: flex; align-items: center; overflow-x: auto; white-space: nowrap;
        box-sizing: border-box; scrollbar-width: none; -ms-overflow-style: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .sub-topnav::-webkit-scrollbar { display: none; }
      .sub-topnav a {
        color: var(--text-light); text-align: center; padding: 8px 16px;
        text-decoration: none; font-size: 15px; line-height: 1.2;
        display: inline-block; transition: background-color 0.3s, color 0.3s;
        cursor: pointer; border-right: 1px solid rgba(255,255,255,0.1);
      }
      .sub-topnav a:last-child { border-right: none; }
      .sub-topnav a:hover {
        background-color: #3a3a3a; color: #fff;
      }
      .sub-topnav a.active-subnav {
        background-color: var(--main-color); color: var(--text-light);
        font-weight: bold;
      }
      body.dark-mode .sub-topnav a.active-subnav { color: var(--button-text-dark); }

      /* Container Principal (Body) */
      .page-body-container {
        display: flex; flex-grow: 1; position: relative;
        height: calc(100vh - var(--total-header-height));
      }

      /* Menu Lateral (Sidenav - M√≥dulos) */
      .sidenav {
        width: var(--sidenav-width); height: 100%; flex-shrink: 0;
        background-color: var(--light-grey-bg); overflow: visible;
        transition: width 0.4s ease-in-out, margin-left 0.4s ease-in-out;
        border-right: 1px solid var(--border-color); box-sizing: border-box;
        display: flex; flex-direction: column; position: relative; z-index: 100;
        margin-left: 0; padding-top: 0;
      }
      .sidenav.collapsed {
        width: 0; margin-left: calc(-1 * var(--sidenav-width));
        border-right: none; overflow: hidden;
      }
      .sidenav-title {
        background-color: var(--main-color); color: var(--text-light);
        padding: 10px 15px; font-size: 1.1em; font-weight: bold;
        margin-bottom: 5px;
        height: calc(var(--subnav-height) + 10px);
        display: flex; align-items: center; box-sizing: border-box;
        position: sticky; top: 0; z-index: 10;
        white-space: normal; word-wrap: break-word; line-height: 1.3;
      }
      body.dark-mode .sidenav-title { color: var(--button-text-dark); }
      .sidenav-links { overflow-y: auto; flex-grow: 1; padding-bottom: 20px; }
      .sidenav a {
        padding: 8px 15px; text-decoration: none; font-size: 16px;
        color: var(--text-dark); display: flex; align-items: center;
        transition: background-color 0.2s, color 0.2s;
        border-left: 4px solid transparent; line-height: 1.4; cursor: pointer;
        gap: 8px;
      }
      .sidenav a:hover {
        background-color: #e0e0e0; color: var(--main-color);
      }
      body.dark-mode .sidenav a:hover {
        background-color: #2d333b; color: var(--text-light);
      }
      .sidenav a.active {
        background-color: var(--light-highlight-bg); color: var(--main-color);
        font-weight: 600; border-left: 4px solid var(--main-color);
      }
      body.dark-mode .sidenav a.active { color: var(--text-light); }
      .sidenav a .icon {
        font-size: 1.1em; color: var(--text-muted);
      }
      .sidenav a:hover .icon, .sidenav a.active .icon {
        color: var(--main-color);
      }
      body.dark-mode .sidenav a .icon { color: var(--text-muted); }
      body.dark-mode .sidenav a:hover .icon, body.dark-mode .sidenav a.active .icon {
        color: var(--text-light);
      }

      /* Bot√£o Toggle SETA (Desktop) */
      .sidenav-toggle-arrow {
        position: absolute; top: 10px;
        right: 8px; background-color: #e0e0e0;
        color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 50%;
        width: 28px; height: 28px; padding: 0; font-size: 16px;
        line-height: 26px; text-align: center; cursor: pointer;
        z-index: 11; transition: background-color 0.3s, color 0.3s, opacity 0.4s, top 0.4s;
        opacity: 1;
      }
      .sidenav-toggle-arrow:hover { background-color: #ccc; color: #000; }
      body.dark-mode .sidenav-toggle-arrow { background-color: #22272e; color: var(--text-muted); border-color: var(--border-color); }
      body.dark-mode .sidenav-toggle-arrow:hover { background-color: #2d333b; color: var(--text-light); }
      .sidenav-toggle-arrow .arrow-right { display: none; }
      .sidenav-toggle-arrow .arrow-left { display: inline; }
      .w3-main > .sidenav-toggle-arrow {
        position: fixed; top: calc(var(--total-header-height) + 10px); left: 10px;
        right: auto; opacity: 1; background-color: var(--light-grey-bg); visibility: visible;
        width: 30px; height: 30px; font-size: 18px; line-height: 28px;
        border-color: var(--border-color); color: var(--text-dark); z-index: 101;
      }
      .w3-main > .sidenav-toggle-arrow .arrow-right { display: inline; }
      .w3-main > .sidenav-toggle-arrow .arrow-left { display: none; }
      body.dark-mode .w3-main > .sidenav-toggle-arrow { background-color: #22272e; }

      /* Bot√£o Toggle MOBILE (Separado) */
      .mobile-toggle-btn {
        display: none; font-size: 24px; cursor: pointer;
        background-color: var(--light-grey-bg); color: var(--text-dark);
        border: 1px solid var(--border-color); padding: 5px 10px;
        position: fixed; top: calc(var(--total-header-height) + 10px);
        left: 10px; z-index: 106; border-radius: 4px;
        transition: background-color 0.3s, top 0.4s;
      }
      .mobile-toggle-btn:hover { background-color: #ddd; }
      body.dark-mode .mobile-toggle-btn {
        background-color: #22272e; color: var(--text-muted); border-color: var(--border-color);
      }
      body.dark-mode .mobile-toggle-btn:hover {
        background-color: #2d333b; color: var(--text-light);
      }

      /* Conte√∫do Principal (Direita) */
      .w3-main {
        flex-grow: 1; background-color: var(--main-content-bg);
        transition: width 0.4s ease-in-out; /* Ajustado para width */
        overflow-y: auto; height: 100%; box-sizing: border-box;
        position: relative;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        width: 100%; /* Garante que o w3-main ocupe o espa√ßo dispon√≠vel */
      }
      .w3-row { padding: 20px; }
      .w3-col.main-column { width: 100%; }
      #main { padding-right: 15px; }
      #main > h1 {
        font-size: 2.2em; color: var(--main-color); margin-bottom: 20px;
        margin-top: 0; font-weight: 600; border-bottom: 2px solid var(--main-color);
        padding-bottom: 8px;
      }
      #main-content-area p {
        line-height: 1.8; margin-bottom: 1.2em; font-size: 1.05em;
        color: var(--text-dark); /* Garante a cor correta */
      }
      #main-content-area h2 {
        margin-top: 1.5em; margin-bottom: 0.8em; color: var(--main-color);
        border-bottom: 1px solid var(--border-color); padding-bottom: 0.5em;
        font-size: 1.5em; font-weight: 500;
      }

      /* Estilos para os containers de Quest√µes/Flashcards */
      .content-section {
        padding: 30px 20px;
        margin-top: 40px;
        border-top: 2px solid var(--main-color);
        background-color: var(--light-highlight-bg);
        min-height: 300px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .content-section h2 {
        margin-top: 0;
        color: var(--main-color);
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.6em;
      }

      /* Bot√µes gerais e navega√ß√£o next/prev */
      .w3-clear::after { content: ""; clear: both; display: table; }
      .nextprev {
        margin-top: 30px; margin-bottom: 10px;
        border-top: 1px solid var(--border-color); padding-top: 20px;
      }
      .nextprev a { text-decoration: none; }
      .w3-btn {
        border: none; display: inline-block; padding: 10px 20px;
        vertical-align: middle; overflow: hidden; text-decoration: none;
        text-align: center; cursor: pointer; white-space: nowrap;
        background-color: var(--accent-1); color: var(--button-text-dark);
        border-radius: 5px; font-weight: 500;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
      }
      .w3-left { float: left!important; }
      .w3-right { float: right!important; }
      .w3-btn:hover {
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        background-color: var(--accent-1-darker) !important;
        color: var(--button-text-dark);
      }

      /* Bot√µes Fixos (Quest√µes/Flashcards) */
      .fixed-action-buttons {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .fixed-action-buttons button {
        padding: 10px 15px;
        font-size: 0.9em;
        font-weight: bold;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s;
      }
      .fixed-action-buttons button#goto-questions-btn {
        background-color: var(--main-color);
        color: var(--text-light);
      }
      body.dark-mode .fixed-action-buttons button#goto-questions-btn {
        color: var(--button-text-dark);
      }
      .fixed-action-buttons button#goto-flashcards-btn {
        background-color: var(--accent-2);
        color: var(--text-light);
      }
      .fixed-action-buttons button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      body.dark-mode .fixed-action-buttons button#goto-questions-btn:hover {
        background-color: #8fceff;
      }
      body.dark-mode .fixed-action-buttons button#goto-flashcards-btn {
        background-color: #d98234;
      }
      body.dark-mode .fixed-action-buttons button#goto-flashcards-btn:hover {
        background-color: #e89a51;
      }

      /* Placeholder Carregamento */
      .loading-placeholder {
        padding: 20px; text-align: center; color: var(--text-muted);
        font-style: italic; font-size: 1em;
      }

      /* Rodap√© */
      .footer {
        background-color: var(--dark-bg);
        color: var(--footer-text-muted);
        padding: 40px 20px;
        text-align: center;
        border-top: 1px solid var(--footer-separator);
        margin-top: auto;
      }
      .footer-content {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        max-width: 1200px;
        margin: 0 auto 20px auto;
      }
      .footer-section {
        min-width: 200px;
        margin: 10px 0;
      }
      .footer h4 {
        color: var(--footer-h4);
        margin-bottom: 15px;
        font-size: 1.1em;
      }
      .footer ul {
        list-style: none;
        padding: 0;
      }
      .footer ul li {
        margin: 8px 0;
      }
      .footer ul li a, .footer-section p a {
        color: var(--footer-link-color);
        text-decoration: none;
        transition: color 0.3s;
      }
      .footer ul li a:hover, .footer-section p a:hover {
        color: var(--footer-link-hover);
      }
      .footer-section p {
        margin: 5px 0;
        line-height: 1.5;
      }
      .footer-copyright {
        border-top: 1px solid var(--footer-separator);
        padding-top: 20px;
        font-size: 0.9em;
      }
      body.dark-mode .footer-copyright {
        border-top-color: var(--border-color);
      }
      .footer-copyright a {
        color: var(--footer-link-color);
        text-decoration: none;
      }
      .footer-copyright a:hover {
        color: var(--footer-link-hover);
      }

      /* --- Responsividade --- */
      @media screen and (max-width: 992px) {
        .w3s-nav-main { display: none; }
        .w3s-header-right-group { gap: 10px; }
        .w3s-header-actions a span.link-text,
        .w3s-header-actions button span.link-text { display: none; }
        .w3s-header { gap: 10px; padding: 0 10px; }
      }
      @media screen and (max-width: 768px) {
        .sidenav-toggle-arrow { display: none !important; }
        .mobile-toggle-btn { display: block; }
        .sidenav {
            position: fixed; top: 0;
            left: calc(-1 * var(--sidenav-width-mobile) - 5px);
            width: var(--sidenav-width-mobile); height: 100vh !important; z-index: 105;
            transition: left 0.4s ease-in-out; background-color: var(--header-bg);
            border-right: 1px solid var(--border-color); margin-left: 0; padding-top: 0;
        }
        .sidenav:not(.collapsed) { left: 0; }
        .w3-main { width: 100% !important; margin-left: 0 !important; }
        .page-body-container { height: calc(100vh - var(--total-header-height)); }
        .mobile-toggle-btn { top: calc(var(--total-header-height) + 10px); left: 10px !important; z-index: 106; }
        .w3-row { padding: 10px; }
        #main h1 { font-size: 1.8em; }
        .w3s-header-actions { gap: 5px; }
        .w3s-header-actions a, .w3s-header-actions button { padding: 3px 5px; }
        .w3s-header-actions a .icon, .w3s-header-actions button .icon { font-size: 1.3em; }
        .fixed-action-buttons { right: 10px; bottom: 10px; }
        .fixed-action-buttons button { padding: 8px 12px; font-size: 0.8em;}
        .footer-content { flex-direction: column; align-items: center; text-align: center; }
        .footer-section { min-width: unset; width: 80%; margin-bottom: 15px;}
      }
      @media screen and (max-width: 480px) {
        /* Ajustes menores se necess√°rio */
      }
    </style>
</head>
<body>
    <header class="w3s-header" id="mainHeader">
        <div class="w3s-logo-area">
            <a href="index.html" title="P√°gina Inicial">
                <svg class="w3s-logo-placeholder" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="48"/>
                    <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle">NVP</text>
                </svg>
            </a>
        </div>
        <div class="w3s-header-right-group">
            <div class="w3s-header-actions">
                <button id="theme-toggle" title="Alternar Tema Claro/Escuro">
                    <span class="icon theme-icon-light">‚òÄÔ∏è</span>
                    <span class="icon theme-icon-dark">üåô</span>
                </button>
                <a href="meucadastro.html" title="Meu Cadastro"><span class="icon">‚öôÔ∏è</span> <span class="link-text">Meu Cadastro</span></a>
                <a href="personalizar.html" title="Personalizar Sala de Estudos" class="active-main-nav"><span class="icon">üìö</span> <span class="link-text">Personalizar Sala de Estudos</span></a>
                <button id="logout-btn" title="Logout"><span class="icon">üö™</span> <span class="link-text">Logout</span></button>
            </div>
        </div>
    </header>

    <nav class="sub-topnav" id="subTopnav">
        <div class="loading-placeholder">Carregando cursos...</div>
    </nav>

    <div class="page-body-container">
        <div id="mySidenav" class="sidenav">
            <div class="sidenav-title" id="sidenavTitle">Selecione um Curso</div>
            <div class="sidenav-links" id="sidenavLinksContainer">
                <div class="loading-placeholder">Carregando m√≥dulos...</div>
            </div>
        </div>

        <main class='w3-main'>
            <button class="sidenav-toggle-arrow" onclick="toggleNav()" title="Recolher/Expandir Menu">
                <span class="arrow-left">‚ùÆ</span>
                <span class="arrow-right" style="display: none;">‚ùØ</span>
            </button>
            <div class='w3-row'>
                <div class='w3-col main-column'>
                    <div id='main'>
                        <h1 id="content-title">Bem-vindo(a)!</h1>
                        <div id="main-content-area">
                            <p class="loading-placeholder">Selecione um curso e um m√≥dulo/t√≥pico para come√ßar.</p>
                        </div>

                        <div id="questoes-app-container" class="content-section">
                            <h2>Quest√µes</h2>
                            <p>Aqui voc√™ poder√° praticar com quest√µes selecionadas sobre o t√≥pico atual.</p>
                        </div>

                        <div id="flashcards-app-container" class="content-section">
                            <h2>Flashcards</h2>
                            <p>Utilize flashcards para memorizar os pontos chave.</p>
                        </div>

                        <div class="w3-clear nextprev">
                            <a class="w3-left w3-btn" href="#" id="prev-item-btn" style="display: none;">‚ùÆ Anterior</a>
                            <a class="w3-right w3-btn" href="#" id="next-item-btn" style="display: none;">Pr√≥ximo ‚ùØ</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="mobile-toggle-btn" onclick="toggleNav()">‚ò∞</button>

    <div class="fixed-action-buttons">
        <button id="goto-questions-btn" title="Ir para Quest√µes">Quest√µes</button>
        <button id="goto-flashcards-btn" title="Ir para Flashcards">Flashcards</button>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section"><h4>Recursos Adicionais</h4><ul><li><a href="#">Quest√µes Comentadas</a></li><li><a href="#">Mapas Mentais</a></li><li><a href="#">Legisla√ß√£o Compilada</a></li></ul></div>
            <div class="footer-section"><h4>Pr√≥ximos M√≥dulos</h4><p><a href="#">Direito Administrativo</a></p><p><a href="#">Portugu√™s para Concursos</a></p></div>
            <div class="footer-section"><h4>Links √öteis</h4><ul><li><a href="#">Termos de Uso</a></li><li><a href="#">Pol√≠tica de Privacidade</a></li><li><a href="#">Sobre N√≥s</a></li><li><a href="#">Mapa do Site</a></li></ul></div>
        </div>
        <div class="footer-copyright"><span>¬© <span id="current-year"></span> NVP Concursos. Todos os direitos reservados.</span></div>
    </footer>

    <?php // wp_footer(); ?>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyD103GQaVxUfLuH-ySnCxu7rl0xE8noaJM",
        authDomain: "nvp-concursos.firebaseapp.com",
        projectId: "nvp-concursos",
        storageBucket: "nvp-concursos.firebasestorage.app",
        messagingSenderId: "397960760271",
        appId: "1:397960760271:web:1550ff01910ae927d860ba"
    };
    let db;
    let auth;
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        db = firebase.firestore();
        console.log("Firebase inicializado com sucesso.");
    } catch (e) {
        console.error("Firebase initialization error:", e);
        alert("Erro cr√≠tico ao inicializar a plataforma. Funcionalidades estar√£o indispon√≠veis.");
        document.getElementById('subTopnav').innerHTML = '<div class="loading-placeholder" style="color:var(--error-color)">Erro de Inicializa√ß√£o</div>';
        document.getElementById('sidenavLinksContainer').innerHTML = '';
        document.getElementById('main-content-area').innerHTML = '<p style="color:var(--error-color)">N√£o foi poss√≠vel conectar ao banco de dados.</p>';
    }
    // --- Fim Configura√ß√£o Firebase ---

    // --- Bloco Dark Mode ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const bodyElement = document.body;
    const sunIcon = themeToggleBtn?.querySelector('.theme-icon-light');
    const moonIcon = themeToggleBtn?.querySelector('.theme-icon-dark');

    function applyTheme(theme) {
        if (theme === 'dark') {
            bodyElement.classList.add('dark-mode');
            if (sunIcon) sunIcon.style.display = 'none';
            if (moonIcon) moonIcon.style.display = 'inline';
        } else {
            bodyElement.classList.remove('dark-mode');
            if (sunIcon) sunIcon.style.display = 'inline';
            if (moonIcon) moonIcon.style.display = 'none';
        }
    }

    try {
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        let initialTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
        applyTheme(initialTheme);

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                let currentTheme = bodyElement.classList.contains('dark-mode') ? 'dark' : 'light';
                let newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
        } else {
            console.warn("Bot√£o de tema '#theme-toggle' n√£o encontrado.");
        }

        prefersDarkScheme.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                let osTheme = e.matches ? 'dark' : 'light';
                applyTheme(osTheme);
            }
        });
    } catch (e) {
        console.error("Error setting up theme:", e);
    }
    // --- Fim Bloco Dark Mode ---

    // --- Sidenav/Layout ---
    let isNavOpen = !(window.innerWidth <= 768);
    const sidenav = document.getElementById("mySidenav");
    const w3Main = document.querySelector('.w3-main');
    const desktopToggleBtn = document.querySelector('.sidenav-toggle-arrow');
    const mobileToggleBtn = document.querySelector('.mobile-toggle-btn');

    function toggleNav() {
        if (!sidenav) {
            console.error("Elemento Sidenav '#mySidenav' n√£o encontrado.");
            return;
        }
        isNavOpen = !isNavOpen;
        sidenav.classList.toggle("collapsed", !isNavOpen);
        if (window.innerWidth <= 768) {
            document.body.classList.toggle("sidenav-open-mobile", isNavOpen);
        }
        adjustLayout();
    }

    function adjustLayout() {
        if (!sidenav || !w3Main || !desktopToggleBtn || !mobileToggleBtn) {
            console.warn("Elementos de layout (sidenav, w3-main, toggle buttons) n√£o encontrados.");
            return;
        }
        try {
            const totalHeaderHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--total-header-height').replace('px', ''));
            const sideNavWidthMobile = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidenav-width-mobile').replace('px', ''));
            const sideNavWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidenav-width').replace('px', ''));

            if (isNaN(totalHeaderHeight) || isNaN(sideNavWidthMobile) || isNaN(sideNavWidth))uyen {
                console.error("N√£o foi poss√≠vel ler as vari√°veis CSS de altura/largura.");
                return;
            }

            mobileToggleBtn.style.top = `calc(${totalHeaderHeight}px + 10px)`;

            if (window.innerWidth > 768) {
                sidenav.style.position = 'relative';
                sidenav.style.height = `calc(100vh - ${totalHeaderHeight}px)`;
                sidenav.style.left = '0';
                mobileToggleBtn.style.display = 'none';
                desktopToggleBtn.style.display = 'block';

                if (sidenav.classList.contains('collapsed')) {
                    // Quando o sidenav est√° recolhido, w3-main ocupa 100% da largura
                    w3Main.style.width = '100%';
                    w3Main.style.marginLeft = '0';
                    if (desktopToggleBtn.parentElement !== w3Main) {
                        w3Main.insertBefore(desktopToggleBtn, w3Main.firstChild);
                    }
                    desktopToggleBtn.style.position = 'fixed';
                    desktopToggleBtn.style.top = `calc(${totalHeaderHeight}px + 10px)`;
                    desktopToggleBtn.style.left = '10px';
                    desktopToggleBtn.style.right = 'auto';
                    desktopToggleBtn.querySelector('.arrow-right').style.display = 'inline';
                    desktopToggleBtn.querySelector('.arrow-left').style.display = 'none';
                } else {
                    // Quando o sidenav est√° vis√≠vel, w3-main ajusta a largura subtraindo a largura do sidenav
                    w3Main.style.width = `calc(100% - ${sideNavWidth}px)`;
                    w3Main.style.marginLeft = `${sideNavWidth}px`;
                    if (desktopToggleBtn.parentElement !== sidenav) {
                        const titleEl = sidenav.querySelector('.sidenav-title');
                        if (titleEl) {
                            sidenav.insertBefore(desktopToggleBtn, titleEl.nextSibling);
                        } else {
                            sidenav.insertBefore(desktopToggleBtn, sidenav.firstChild);
                        }
                    }
                    desktopToggleBtn.style.position = 'absolute';
                    desktopToggleBtn.style.top = `10px`;
                    desktopToggleBtn.style.left = 'auto';
                    desktopToggleBtn.style.right = '8px';
                    desktopToggleBtn.querySelector('.arrow-right').style.display = 'none';
                    desktopToggleBtn.querySelector('.arrow-left').style.display = 'inline';
                }
            } else {
                // Modo mobile
                sidenav.style.position = 'fixed';
                sidenav.style.height = '100vh';
                sidenav.style.top = '0';
                mobileToggleBtn.style.display = 'block';
                desktopToggleBtn.style.display = 'none';
                w3Main.style.width = '100%'; // Garante largura total no mobile
                w3Main.style.marginLeft = '0';
                sidenav.style.left = sidenav.classList.contains('collapsed') ? `-${sideNavWidthMobile + 5}px` : '0px';
                document.body.classList.toggle("sidenav-open-mobile", !sidenav.classList.contains('collapsed'));
            }
        } catch (e) {
            console.error("Erro ajustando layout:", e);
        }
    }
    // --- Fim Sidenav/Layout ---

    // --- Logout ---
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            if (!auth) {
                console.error("Firebase Auth n√£o inicializado.");
                return;
            }
            auth.signOut().then(() => {
                console.log('Logout bem-sucedido.');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao tentar sair. Tente novamente.');
            });
        });
    } else {
        console.warn("Bot√£o de logout '#logout-btn' n√£o encontrado.");
    }
    // --- Fim Logout ---

    // --- Bot√µes Fixos Scroll ---
    const gotoQuestionsBtn = document.getElementById('goto-questions-btn');
    const gotoFlashcardsBtn = document.getElementById('goto-flashcards-btn');
    const questionsContainer = document.getElementById('questoes-app-container');
    const flashcardsContainer = document.getElementById('flashcards-app-container');

    if (gotoQuestionsBtn && questionsContainer) {
        gotoQuestionsBtn.addEventListener('click', () => {
            questionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    } else {
        console.warn("Bot√£o ou container de Quest√µes n√£o encontrado (#goto-questions-btn, #questoes-app-container).");
    }

    if (gotoFlashcardsBtn && flashcardsContainer) {
        gotoFlashcardsBtn.addEventListener('click', () => {
            flashcardsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    } else {
        console.warn("Bot√£o ou container de Flashcards n√£o encontrado (#goto-flashcards-btn, #flashcards-app-container).");
    }
    // --- Fim Bot√µes Fixos ---

    // --- L√ìGICA PRINCIPAL DA SALA DE ESTUDOS ---
    const subTopnavContainer = document.getElementById('subTopnav');
    const sidenavTitle = document.getElementById('sidenavTitle');
    const sidenavLinksContainer = document.getElementById('sidenavLinksContainer');
    const contentTitle = document.getElementById('content-title');
    const mainContentArea = document.getElementById('main-content-area');
    const prevItemBtn = document.getElementById('prev-item-btn');
    const nextItemBtn = document.getElementById('next-item-btn');

    // Vari√°veis de estado global
    let allCoursesData = [];
    let userPreferences = null;
    let coursesToDisplay = [];
    let currentCourse = null;
    let currentModule = null;
    let currentSubtopic = null;
    let currentSubtopicsList = [];

    // 1. Fun√ß√£o Principal de Inicializa√ß√£o
    async function initializeStudyRoom(user) {
        if (!user || !db) {
            console.error("Inicializa√ß√£o abortada: usu√°rio ou DB n√£o dispon√≠veis.");
            return;
        }
        console.log("Iniciando Sala de Estudos para:", user.uid);
        showLoadingState("Carregando dados...");

        try {
            const userDocRef = db.collection('users').doc(user.uid);
            const getUserData = userDocRef.get();
            const getAllCourses = fetchAllCoursesAndModules();

            const [userDoc, fetchedCoursesData] = await Promise.all([getUserData, getAllCourses]);

            if (userDoc.exists) {
                userPreferences = userDoc.data();
                console.log("Prefer√™ncias do usu√°rio:", userPreferences);
            } else {
                console.warn(`Documento do usu√°rio ${user.uid} n√£o encontrado.`);
                userPreferences = { hasPersonalized: false, selectedSubtopics: [] };
            }

            allCoursesData = fetchedCoursesData;

            if (userPreferences?.hasPersonalized === true && userPreferences.selectedSubtopics?.length > 0) {
                coursesToDisplay = await Promise.all(allCoursesData.map(async (course) => {
                    const filteredModules = await Promise.all(course.modules.map(async (module) => {
                        const subtopics = await fetchSubtopicsForModule(course.id, module.id);
                        const filteredSubtopics = subtopics.filter(subtopic => userPreferences.selectedSubtopics.includes(subtopic.id));
                        if (filteredSubtopics.length > 0) {
                            return { ...module, subtopics: filteredSubtopics };
                        }
                        return null;
                    }));
                    const validModules = filteredModules.filter(module => module !== null);
                    if (validModules.length > 0) {
                        return { ...course, modules: validModules };
                    }
                    return null;
                }));
                coursesToDisplay = coursesToDisplay.filter(course => course !== null);
                console.log(`Exibindo ${coursesToDisplay.length} cursos personalizados.`);
                if (coursesToDisplay.length === 0) {
                    console.warn("Usu√°rio personalizou, mas sele√ß√£o atual n√£o corresponde a nenhum curso/m√≥dulo/se√ß√£o existente.");
                    showErrorState("Sua personaliza√ß√£o n√£o corresponde a nenhum conte√∫do dispon√≠vel. Visite 'Personalizar Sala de Estudos' para ajustar.");
                    return;
                }
            } else {
                coursesToDisplay = await Promise.all(allCoursesData.map(async (course) => {
                    const modulesWithSubtopics = await Promise.all(course.modules.map(async (module) => {
                        const subtopics = await fetchSubtopicsForModule(course.id, module.id);
                        return { ...module, subtopics };
                    }));
                    return { ...course, modules: modulesWithSubtopics };
                }));
                console.log("Exibindo todos os cursos, m√≥dulos e se√ß√µes.");
                if (coursesToDisplay.length === 0) {
                    showErrorState("Nenhum curso foi encontrado no sistema.");
                    return;
                }
            }
            renderUI(coursesToDisplay);

        } catch (error) {
            console.error("Erro fatal durante a inicializa√ß√£o:", error);
            if (error.code === 'permission-denied') {
                showErrorState("Acesso restrito. Voc√™ precisa ser assinante para visualizar este conte√∫do.");
            } else {
                showErrorState("Erro ao carregar seus dados. Tente atualizar a p√°gina (F5).");
            }
        }
    }

    // 2. Busca Cursos e M√≥dulos (Subcole√ß√µes)
    async function fetchAllCoursesAndModules() {
        if (!db) {
            console.error("Firestore DB n√£o inicializado.");
            return [];
        }
        console.log("Buscando cursos e m√≥dulos...");
        const coursesRef = db.collection('courses').orderBy('order');
        try {
            const coursesSnapshot = await coursesRef.get();
            if (coursesSnapshot.empty) {
                console.warn("Cole√ß√£o 'courses' vazia.");
                return [];
            }

            const coursePromises = coursesSnapshot.docs.map(async (courseDoc) => {
                const courseData = courseDoc.data();
                const modulesRef = courseDoc.ref.collection('modules').orderBy('order');
                const modulesSnapshot = await modulesRef.get();
                const modules = modulesSnapshot.docs.map(moduleDoc => ({ id: moduleDoc.id, ...moduleDoc.data() }));
                return { id: courseDoc.id, ...courseData, modules: modules || [] };
            });
            return await Promise.all(coursePromises);
        } catch (error) {
            console.error("Erro buscando cursos/m√≥dulos:", error);
            throw error;
        }
    }

    // 3. Busca Subt√≥picos de um M√≥dulo
    async function fetchSubtopicsForModule(courseId, moduleId) {
        if (!db) {
            console.error("Firestore DB n√£o inicializado.");
            return [];
        }
        console.log(`Buscando subt√≥picos: ${courseId}/${moduleId}`);
        if (sidenavLinksContainer) sidenavLinksContainer.innerHTML = '<div class="loading-placeholder">Carregando t√≥picos...</div>';
        const subtopicsRef = db.collection('courses').doc(courseId).collection('modules').doc(moduleId).collection('subtopics').orderBy('order');
        try {
            const snapshot = await subtopicsRef.get();
            const subtopics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`Encontrados ${subtopics.length} subt√≥picos para ${moduleId}.`);
            return subtopics;
        } catch (error) {
            console.error(`Erro buscando subt√≥picos (${moduleId}):`, error);
            if (sidenavLinksContainer) sidenavLinksContainer.innerHTML = '<div class="loading-placeholder" style="color:var(--error-color)">Erro ao carregar t√≥picos.</div>';
            return [];
        }
    }

    // 4. Busca Conte√∫do de um Subt√≥pico
    async function fetchSubtopicContent(courseId, moduleId, subtopicId) {
        if (!db) {
            console.error("Firestore DB n√£o inicializado.");
            return "<p>Erro de conex√£o.</p>";
        }
        console.log(`Buscando conte√∫do: ${courseId}/${moduleId}/${subtopicId}`);
        if (mainContentArea) mainContentArea.innerHTML = '<p class="loading-placeholder">Carregando conte√∫do...</p>';
        const subtopicRef = db.collection('courses').doc(courseId).collection('modules').doc(moduleId).collection('subtopics').doc(subtopicId);
        try {
            const doc = await subtopicRef.get();
            if (doc.exists) {
                const content = doc.data().content;
                return content || "<p>T√≥pico sem conte√∫do definido.</p>";
            } else {
                console.warn(`Subt√≥pico ${subtopicId} n√£o encontrado.`);
                return "<p>Erro: Conte√∫do n√£o encontrado.</p>";
            }
        } catch (error) {
            console.error(`Erro buscando conte√∫do (${subtopicId}):`, error);
            return "<p>Erro ao carregar conte√∫do.</p>";
        }
    }

    // --- Fun√ß√µes de Renderiza√ß√£o ---
    function renderUI(courses) {
        renderSubNav(courses);
        if (courses?.length > 0) {
            selectCourse(courses[0].id);
        } else {
            if (!userPreferences || !userPreferences.hasPersonalized) {
                showErrorState("Nenhum curso encontrado no sistema.");
            }
        }
        adjustLayout();
    }

    function renderSubNav(courses) {
        if (!subTopnavContainer) {
            console.error("#subTopnav n√£o encontrado");
            return;
        }
        subTopnavContainer.innerHTML = '';
        if (!courses || courses.length === 0) {
            subTopnavContainer.innerHTML = '<div class="loading-placeholder" style="padding: 8px 16px; color: var(--text-light);">Nenhum curso para exibir.</div>';
            return;
        }
        courses.forEach((course, index) => {
            const link = document.createElement('a');
            link.href = "#";
            link.textContent = course.name;
            link.dataset.courseId = course.id;
            if (index === 0) {
                link.classList.add('active-subnav');
            }
            link.onclick = (event) => {
                event.preventDefault();
                selectCourse(course.id);
            };
            subTopnavContainer.appendChild(link);
        });
    }

    function renderSideNav(items, type = 'module') {
        if (!sidenavLinksContainer || !sidenavTitle) {
            console.error("Sidenav links/title n√£o encontrados");
            return;
        }
        sidenavLinksContainer.innerHTML = '';

        if (type === 'subtopic' && currentCourse && currentModule) {
            const backButton = document.createElement('button');
            backButton.innerHTML = `‚ùÆ Voltar`;
            backButton.className = 'sidenav-back-button';
            backButton.title = `Voltar para m√≥dulos de ${currentCourse.name}`;
            backButton.style.padding = '8px 15px';
            backButton.style.background = 'none';
            backButton.style.border = 'none';
            backButton.style.color = 'var(--text-dark)';
            backButton.style.cursor = 'pointer';
            backButton.style.display = 'block';
            backButton.style.width = '100%';
            backButton.style.textAlign = 'left';
            backButton.onmouseover = () => backButton.style.backgroundColor = '#e0e0e0';
            backButton.onmouseout = () => backButton.style.backgroundColor = 'transparent';
            backButton.onclick = () => {
                renderSideNav(currentCourse.modules, 'module');
                updateContent(currentModule.name, null, `<p>Selecione um t√≥pico ou volte.</p>`, null);
                currentModule = null;
                currentSubtopic = null;
                currentSubtopicsList = [];
            };
            sidenavLinksContainer.appendChild(backButton);
            sidenavTitle.textContent = currentModule.name;
        } else if (currentCourse) {
            sidenavTitle.textContent = currentCourse.name;
        } else {
            sidenavTitle.textContent = "Erro";
        }

        if (!items || items.length === 0) {
            sidenavLinksContainer.innerHTML += `<div class="loading-placeholder">Nenhum ${type === 'module' ? 'm√≥dulo' : 't√≥pico'} encontrado.</div>`;
            return;
        }
        items.forEach((item) => {
            const link = document.createElement('a');
            link.href = "#";
            link.dataset.id = item.id;
            link.dataset.type = type;
            const icon = document.createElement('span');
            icon.className = 'icon';
            icon.textContent = type === 'module' ? 'üìò' : 'üìÑ';
            link.appendChild(icon);
            const text = document.createElement('span');
            text.textContent = item.name;
            link.appendChild(text);
            if (type === 'module') {
                link.onclick = (event) => {
                    event.preventDefault();
                    selectModule(item.id);
                };
            } else {
                link.classList.add('subtopic-link');
                link.onclick = (event) => {
                    event.preventDefault();
                    selectSubtopic(item.id, link);
                };
            }
            sidenavLinksContainer.appendChild(link);
        });
    }

    function updateContent(title, activeElement, contentHtml, siblingItems) {
        if (contentTitle) contentTitle.textContent = title;
        if (mainContentArea) {
            mainContentArea.innerHTML = contentHtml || '<p class="loading-placeholder">Selecione um item.</p>';
            if (w3Main) w3Main.scrollTop = 0;
        }

        document.querySelectorAll('#sidenavLinksContainer a, #sidenavLinksContainer button').forEach(el => el.classList.remove('active'));
        if (activeElement) {
            activeElement.classList.add('active');
            currentSubtopic = (activeElement.dataset.type === 'subtopic') ? siblingItems?.find(s => s.id === activeElement.dataset.id) : null;
        } else {
            currentSubtopic = null;
        }

        updateNavButtons(siblingItems, activeElement?.dataset.id);

        if (window.innerWidth <= 768 && isNavOpen) {
            toggleNav();
        }
    }

    function updateNavButtons(items, selectedItemId) {
        if (!prevItemBtn || !nextItemBtn) {
            console.error("Bot√µes Prev/Next n√£o encontrados.");
            return;
        }
        if (!items || items.length === 0 || !selectedItemId) {
            prevItemBtn.style.display = 'none';
            nextItemBtn.style.display = 'none';
            return;
        }
        const currentIndex = items.findIndex(item => item.id === selectedItemId);
        if (currentIndex === -1) {
            prevItemBtn.style.display = 'none';
            nextItemBtn.style.display = 'none';
            return;
        }

        prevItemBtn.style.display = (currentIndex > 0) ? 'inline-block' : 'none';
        if (currentIndex > 0) {
            const prevItem = items[currentIndex - 1];
            prevItemBtn.onclick = (e) => {
                e.preventDefault();
                sidenavLinksContainer.querySelector(`a[data-id="${prevItem.id}"]`)?.click();
            };
        }

        nextItemBtn.style.display = (currentIndex < items.length - 1) ? 'inline-block' : 'none';
        if (currentIndex < items.length - 1) {
            const nextItem = items[currentIndex + 1];
            nextItemBtn.onclick = (e) => {
                e.preventDefault();
                sidenavLinksContainer.querySelector(`a[data-id="${nextItem.id}"]`)?.click();
            };
        }
    }

    // --- Fun√ß√µes de L√≥gica de Sele√ß√£o ---
    function selectCourse(courseId) {
        currentCourse = coursesToDisplay.find(c => c.id === courseId);
        currentModule = null;
        currentSubtopic = null;
        currentSubtopicsList = [];

        if (currentCourse) {
            console.log("Curso selecionado:", currentCourse.name);
            document.querySelectorAll('#subTopnav a').forEach(link => {
                link.classList.toggle('active-subnav', link.dataset.courseId === courseId);
            });
            renderSideNav(currentCourse.modules, 'module');
            updateContent(`Curso: ${currentCourse.name}`, null, `<p>Selecione um m√≥dulo ao lado.</p>`, null);
        } else {
            console.error("Erro interno: Curso selecionado n√£o encontrado em coursesToDisplay.", courseId);
            showErrorState("Erro ao selecionar o curso.");
        }
    }

    async function selectModule(moduleId) {
        if (!currentCourse) {
            console.error("Tentou selecionar m√≥dulo sem curso ativo.");
            return;
        }
        currentModule = currentCourse.modules.find(m => m.id === moduleId);
        currentSubtopic = null;

        if (currentModule) {
            console.log("M√≥dulo selecionado:", currentModule.name);
            document.querySelectorAll('#sidenavLinksContainer a').forEach(link => {
                link.classList.toggle('active', link.dataset.id === moduleId && link.dataset.type === 'module');
            });

            currentSubtopicsList = currentModule.subtopics || [];
            renderSideNav(currentSubtopicsList, 'subtopic');

            if (currentSubtopicsList.length > 0) {
                const firstSubtopicLink = sidenavLinksContainer.querySelector(`a[data-id="${currentSubtopicsList[0].id}"]`);
                if (firstSubtopicLink) {
                    selectSubtopic(currentSubtopicsList[0].id, firstSubtopicLink);
                } else {
                    console.error("Link do primeiro subt√≥pico n√£o encontrado ap√≥s renderiza√ß√£o.");
                    updateContent(currentModule.name, null, "<p>Erro ao exibir t√≥picos.</p>", currentSubtopicsList);
                }
            } else {
                updateContent(currentModule.name, null, "<p>Este m√≥dulo n√£o possui t√≥picos cadastrados.</p>", []);
            }
        } else {
            console.error("M√≥dulo n√£o encontrado:", moduleId);
        }
    }

    async function selectSubtopic(subtopicId, clickedElement) {
        if (!currentCourse || !currentModule) {
            console.error("Tentou selecionar subt√≥pico sem curso/m√≥dulo ativo.");
            return;
        }
        currentSubtopic = currentSubtopicsList.find(s => s.id === subtopicId);

        if (currentSubtopic) {
            console.log("Subt√≥pico selecionado:", currentSubtopic.name);
            const contentHtml = await fetchSubtopicContent(currentCourse.id, currentModule.id, subtopicId);
            updateContent(currentSubtopic.name, clickedElement, contentHtml, currentSubtopicsList);
        } else {
            console.error("Subt√≥pico n√£o encontrado na lista atual:", subtopicId);
            updateContent("Erro", clickedElement, "<p>Erro ao encontrar dados do t√≥pico.</p>", currentSubtopicsList);
        }
    }

    // --- Fun√ß√µes Auxiliares de UI ---
    function showLoadingState(message = "Carregando...") {
        if (subTopnavContainer) subTopnavContainer.innerHTML = `<div class="loading-placeholder" style="padding: 8px 16px; color: var(--text-light);">${message}</div>`;
        if (sidenavTitle) sidenavTitle.textContent = message;
        if (sidenavLinksContainer) sidenavLinksContainer.innerHTML = `<div class="loading-placeholder">${message}</div>`;
        if (contentTitle) contentTitle.textContent = message;
        if (mainContentArea) mainContentArea.innerHTML = `<p class="loading-placeholder">${message}</p>`;
    }

    function showErrorState(message) {
        console.error("Exibindo Estado de Erro:", message);
        if (subTopnavContainer) subTopnavContainer.innerHTML = '<div class="loading-placeholder kepada style="padding: 8px 16px; color: var(--error-color);">Erro</div>';
        if (sidenavTitle) sidenavTitle.textContent = 'Erro';
        if (sidenavLinksContainer) sidenavLinksContainer.innerHTML = `<div class="loading-placeholder" style="color:var(--error-color)">${message}</div>`;
        if (contentTitle) contentTitle.textContent = 'Erro';
        if (mainContentArea) mainContentArea.innerHTML = `<p class="loading-placeholder" style="color:var(--error-color)">${message}</p>`;
    }

    // --- Verifica√ß√£o de Autentica√ß√£o e Inicializa√ß√£o ---
    if (auth) {
        auth.onAuthStateChanged(user => {
            console.log("Auth state changed. User object:", user);
            if (user) {
                initializeStudyRoom(user);
            } else {
                console.log("Nenhum usu√°rio logado. Redirecionando para index.html.");
                window.location.href = 'index.html';
            }
        });
    } else {
        console.error("Firebase Auth n√£o foi inicializado corretamente. Verifique a configura√ß√£o.");
        showErrorState("Erro na configura√ß√£o. N√£o √© poss√≠vel autenticar.");
    }

    // --- Listeners Globais (DOM e Resize) ---
    document.addEventListener('DOMContentLoaded', () => {
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
        if (window.innerWidth <= 768) {
            isNavOpen = false;
        } else {
            isNavOpen = true;
        }
        if (sidenav && !isNavOpen) {
            sidenav.classList.add('collapsed');
        } else if (sidenav) {
            sidenav.classList.remove('collapsed');
        }
        adjustLayout();
    });
    window.addEventListener('resize', adjustLayout);
    </script>
</body>
</html>