<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Estudos - PRO Concursos</title>
    <style>
        /* --- :ROOT Variables --- */
        :root {
            --header-height: 55px;
            --sidebar-width: 240px;
            --main-color: #1A5276;
            --light-highlight-bg: #EAF2F8;
            --accent-1: #D4AC0D;
            --accent-1-darker: #b3910b;
            --accent-2: #CA6F1E;
            --dark-bg: #154360;
            --subnav-bg: #ddd;
            --text-dark: #333;
            --text-light: #f8f9fa;
            --text-muted: #6c757d;
            --border-color: #ccc;
            --light-grey-bg: #f1f1f1;
            --header-bg: #ffffff;
            --header-border: #e7e7e7;
            --main-content-bg: #ffffff;
            --code-bg: #f1f1f1;
            --button-text-dark: #333;
            --footer-text-muted: #ccc;
            --footer-link-color: #ccc;
            --footer-link-hover: var(--accent-1);
            --footer-separator: #555;
            --footer-h4: #f1f1f1;
            --dark-blue-hover: #113a54;
            --error-color: #D32F2F;
            --sidebar-bg: #f1f1f1;
            --sidebar-border: #d4d4d4;
            --sidebar-link-color: #000;
            --sidebar-link-hover-bg: #ddd;
            --sidebar-link-active-bg: #4CAF50; /* Cor verde para links ativos na sidebar */
            --sidebar-link-active-color: #fff;
            --floating-panel-bg: #fdfdfd;
            --floating-panel-border: #ccc;
            --floating-panel-shadow: 0 2px 10px rgba(0,0,0,0.15);
            --floating-panel-width: 350px;
            --top-nav-bg: #ffffff;
            --top-nav-link-color: #333;
            --top-nav-link-hover-bg: #f1f1f1;
            --top-nav-link-active-bg: #ddd;
            --mega-menu-bg: #f8f9fa;
            --mega-menu-border: #dee2e6;
            --mega-menu-shadow: 0 8px 16px rgba(0,0,0,0.1);
            --mega-menu-link-color: #212529;
            --mega-menu-link-hover-color: #0056b3;
            --mega-menu-heading-color: #495057;
            --modern-green-button-bg: #28a745; /* Verde para o bot√£o moderno */
            --modern-green-button-hover-bg: #218838;
            --modern-green-button-active-bg: #1e7e34;
        }

        /* --- Dark Mode Variables --- */
        body.dark-mode {
            --main-color: #6cb6ff;
            --light-highlight-bg: #2d333b;
            --accent-1: #e4c05c;
            --accent-1-darker: #cfae51;
            --accent-2: #d98234;
            --dark-bg: #0d1117;
            --subnav-bg: #22272e;
            --text-dark: #e6edf3;
            --text-light: #f0f6fc;
            --text-muted: #8b949e;
            --border-color: #444c56;
            --light-grey-bg: #0d1117;
            --header-bg: #161b22;
            --header-border: #30363d;
            --main-content-bg: #0d1117;
            --code-bg: #22272e;
            --button-text-dark: #161b22; /* Ajuste para texto do bot√£o em modo escuro se necess√°rio */
            --footer-text-muted: #8b949e;
            --footer-link-color: #8b949e;
            --footer-link-hover: var(--accent-1);
            --footer-separator: #30363d;
            --footer-h4: var(--text-light);
            --dark-blue-hover: #1a6fba;
            --error-color: #FF5252;
            --sidebar-bg: #161b22;
            --sidebar-border: #30363d;
            --sidebar-link-color: var(--text-light);
            --sidebar-link-hover-bg: #22272e;
            --sidebar-link-active-bg: var(--modern-green-button-bg); /* Usar o mesmo verde */
            --sidebar-link-active-color: #fff;
            --floating-panel-bg: #22272e;
            --floating-panel-border: #30363d;
            --floating-panel-shadow: 0 2px 10px rgba(0,0,0,0.3);
            --top-nav-bg: #161b22;
            --top-nav-link-color: var(--text-light);
            --top-nav-link-hover-bg: #2d333b;
            --top-nav-link-active-bg: #0d1117;
            --mega-menu-bg: #212529;
            --mega-menu-border: #343a40;
            --mega-menu-shadow: 0 8px 16px rgba(0,0,0,0.4);
            --mega-menu-link-color: #adb5bd;
            --mega-menu-link-hover-color: #dee2e6;
            --mega-menu-heading-color: #ced4da;
            --modern-green-button-bg: #28a745;
            --modern-green-button-hover-bg: #218838;
            --modern-green-button-active-bg: #1e7e34;
        }

        /* --- Reset e Base --- */
        html { height: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--light-grey-bg);
            color: var(--text-dark);
            padding-top: var(--header-height);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Header --- */
        .w3s-header {
            background-color: var(--header-bg);
            color: var(--text-dark);
            display: flex;
            align-items: center;
            padding: 0 10px 0 0;
            height: var(--header-height);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 105;
            border-bottom: 1px solid var(--header-border);
            gap: 5px;
        }
        .w3s-sidebar-toggle {
            background-color: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0 15px;
            color: var(--text-dark);
            line-height: var(--header-height);
            margin-right: 5px;
        }
        .w3s-sidebar-toggle:hover { background-color: var(--light-grey-bg); }
        .w3s-logo-area { display: flex; align-items: center; flex-shrink: 0; padding-left: 10px; }
        .w3s-logo-placeholder { width: 35px; height: 35px; margin-right: 8px; }
        .w3s-logo-placeholder text { font-size: 35px; fill: var(--main-color); font-weight: bold; font-family: sans-serif; }
        .w3s-logo-placeholder circle { fill: transparent; stroke: var(--main-color); stroke-width: 5; }

        /* --- Top Navigation (Esquerda com Dropdowns) --- */
        .w3s-top-nav { display: flex; align-items: center; height: 100%; margin-left: 10px; position: relative; }
        .w3s-top-nav button.nav-button {
            display: flex;
            align-items: center;
            padding: 0 12px;
            height: 100%;
            color: var(--top-nav-link-color);
            font-size: 15px;
            background-color: transparent;
            border: none;
            border-right: 1px solid var(--header-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .w3s-top-nav button.nav-button:first-child { border-left: 1px solid var(--header-border); }
        .w3s-top-nav button.nav-button:hover { background-color: var(--top-nav-link-hover-bg); }
        .w3s-top-nav button.nav-button.active { background-color: var(--top-nav-link-active-bg); }

        /* --- Mega Menu Panel --- */
        .mega-menu-panel {
            display: none;
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: 100%;
            max-height: calc(100vh - var(--header-height));
            overflow-y: auto;
            background-color: var(--mega-menu-bg);
            border-top: 1px solid var(--mega-menu-border);
            box-shadow: var(--mega-menu-shadow);
            z-index: 104;
            padding: 25px 30px;
        }
        .mega-menu-panel.active {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .mega-menu-column { flex: 1; min-width: 200px; padding: 0 15px; }
        .mega-menu-column:not(:last-child) { border-right: 1px solid var(--mega-menu-border); }
        .mega-menu-column h4 { font-size: 1.1em; color: var(--mega-menu-heading-color); margin: 0 0 15px; padding-bottom: 8px; border-bottom: 1px solid var(--mega-menu-border); }
        .mega-menu-column a { display: block; color: var(--mega-menu-link-color); text-decoration: none; padding: 6px 0; font-size: 0.95em; transition: color 0.2s; }
        .mega-menu-column a:hover { color: var(--mega-menu-link-hover-color); }

        /* --- Header Actions (Direita) --- */
        .w3s-header-right-group { display: flex; align-items: center; margin-left: auto; gap: 10px; padding-right: 15px; }
        .w3s-header-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .w3s-header-actions a, .w3s-header-actions button {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            border-radius: 4px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .w3s-header-actions a .icon, .w3s-header-actions button .icon { font-size: 1.1em; color: #666; }
        body.dark-mode .w3s-header-actions a .icon, body.dark-mode .w3s-header-actions button .icon { color: var(--text-muted); }
        .w3s-header-actions a:hover, .w3s-header-actions button:hover { color: var(--main-color); background-color: rgba(0, 0, 0, 0.03); }
        body.dark-mode .w3s-header-actions a:hover, body.dark-mode .w3s-header-actions button:hover { background-color: rgba(255, 255, 255, 0.05); }
        .w3s-header-actions a:hover .icon, .w3s-header-actions button:hover .icon { color: var(--main-color); }
        .w3s-header-actions a[title="Meu Cadastro"] .icon { color: #58a6ff; }
        .w3s-header-actions a[title="Guia do M√©todo"] .icon { color: #3fb950; }
        .w3s-header-actions button[title="Logout"] .icon { color: #f78166; }
        .w3s-header-actions button[title="Mudar Cor de Fundo"] .icon { color: #e91e63; }
        #theme-toggle .icon { font-size: 1.3em; }

        /* --- Content Wrapper --- */
        .content-wrapper { display: flex; flex-grow: 1; }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 102;
            transform: translateX(0);
        }
        .sidebar.hidden { transform: translateX(calc(-1 * var(--sidebar-width))); }
        .sidebar h2 { 
            font-size: 1.3em; 
            color: var(--text-dark); 
            margin: 0; 
            padding: 15px 20px; 
            font-weight: 600; 
            border-bottom: 1px solid var(--sidebar-border);
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
        }
        /* .w3s-sidebar-toggle j√° definido no Header */
        .sidebar-nav { list-style: none; padding: 0; margin: 0; }
        .course-item { margin-bottom: 10px; }
        .course-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            color: var(--sidebar-link-color);
            font-size: 0.95em;
            font-weight: bold;
        }
        .course-header:hover { background-color: var(--sidebar-link-hover-bg); }
        .course-header .toggle-icon { margin-left: auto; font-size: 0.8em; transition: transform 0.2s ease; }
        .course-header .toggle-icon.expanded { transform: rotate(90deg); }
        .module-list { list-style: none; padding: 0; margin: 0; display: none; }
        .module-list.visible { display: block; }
        .module-item { margin-bottom: 5px; }
        .module-header {
            display: flex;
            align-items: center;
            padding: 8px 30px;
            cursor: pointer;
            color: var(--sidebar-link-color);
            font-size: 0.95em;
        }
        .module-header:hover { background-color: var(--sidebar-link-hover-bg); }
        .module-header .toggle-icon { margin-left: auto; font-size: 0.8em; transition: transform 0.2s ease; }
        .module-header .toggle-icon.expanded { transform: rotate(90deg); }
        .subtopic-list { list-style: none; padding: 0; margin: 0; display: none; }
        .subtopic-list.visible { display: block; }
        .subtopic-item a {
            display: block;
            padding: 8px 40px;
            color: var(--sidebar-link-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .subtopic-item a:hover { background-color: var(--sidebar-link-hover-bg); }
        .subtopic-item a.active { background-color: var(--sidebar-link-active-bg); color: var(--sidebar-link-active-color); }

        /* --- Main Content Area --- */
        main {
            flex-grow: 1;
            background-color: var(--main-content-bg);
            color: var(--text-dark);
            margin-left: var(--sidebar-width);
            padding: 30px 25px;
            transition: margin-left 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            position: relative;
            z-index: 1;
        }
        main.sidebar-hidden { margin-left: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .study-room-header { text-align: center; margin-bottom: 30px; }
        .study-room-header h1 { font-size: 2em; color: var(--main-color); margin-bottom: 10px; }
        .study-room-header p { color: var(--text-muted); font-size: 1.1em; }
        #lessonContent { min-height: 300px; }

        /* --- Floating Tools Panel (se houver) --- */
        #floatingToolsPanel {
            /* Estilos existentes... */
        }
        
        /* --- NOVO: Estilos para o Bot√£o de Quest√µes Fixo Moderno --- */
        .proconcursos-questoes-container { /* Cont√™iner do bot√£o */
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1010; /* Acima da maioria dos elementos, mas abaixo de modais de alta prioridade se houver */
        }

        .proconcursos-questoes-btn { /* Estilo do bot√£o */
            background-color: var(--modern-green-button-bg);
            color: white;
            padding: 15px 30px; 
            border: none;
            border-radius: 50px; /* Bordas bem arredondadas */
            font-size: 1.1em; 
            font-weight: 600; 
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex; /* Para alinhar √≠cone e texto se adicionar √≠cone no futuro */
            align-items: center;
            gap: 8px; /* Espa√ßo entre √≠cone e texto se adicionar √≠cone */
        }

        .proconcursos-questoes-btn:hover {
            background-color: var(--modern-green-button-hover-bg);
            transform: translateY(-3px); /* Efeito de eleva√ß√£o */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .proconcursos-questoes-btn:active {
            background-color: var(--modern-green-button-active-bg);
            transform: translateY(-1px); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        /* --- FIM: Estilos para o Bot√£o de Quest√µes --- */


        /* --- Estilos do Conte√∫do Carregado --- */
        .module-content { padding: 1rem; color: var(--text-dark); }
        body.dark-mode .module-content { color: var(--text-light); }
        .module-title { color: var(--main-color); margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-size: 1.5em; }
        .section-title { color: var(--main-color); margin: 2rem 0 1rem; font-size: 1.2em; }
        .module-content p { margin-bottom: 1rem; line-height: 1.6; }
        .content-list, .content-list-disc, .content-list-circle { margin-left: 1.5rem; margin-bottom: 1rem; line-height: 1.6; }
        .content-list li, .content-list-disc li, .content-list-circle li { margin-bottom: 0.5rem; }
        .content-list-disc { list-style-type: disc; }
        .content-list-circle { list-style-type: circle; }
        .content-note { background-color: var(--light-highlight-bg); padding: 0.8rem; border-radius: 4px; margin-bottom: 1rem; }
        body.dark-mode .content-note { background-color: var(--dark-bg); }
        .highlight-yellow { color: var(--accent-1); }
        .highlight-red { color: var(--error-color); }
        .highlight-blue { color: var(--main-color); }
        .italic { font-style: italic; }

        /* --- Responsividade --- */
        @media screen and (max-width: 992px) {
            :root { --sidebar-width: 200px; }
            .w3s-top-nav button.nav-button { font-size: 14px; padding: 0 8px; }
            .w3s-header-actions .link-text { display: none; }
            .w3s-header-actions a, .w3s-header-actions button { padding: 6px 8px; }
            #floatingToolsPanel { width: 300px; }
            .mega-menu-column { min-width: 180px; }
        }
        @media screen and (max-width: 768px) {
            :root { --sidebar-width: 240px; }
            .sidebar { 
                transform: translateX(calc(-1 * var(--sidebar-width))); 
                width: var(--sidebar-width);
            }
            .sidebar.visible { transform: translateX(0); }
            main { margin-left: 0; }
            /* .w3s-sidebar-toggle { display: block; }  J√° est√° no header, n√£o precisa redefinir aqui */
            #floatingToolsPanel { width: calc(100% - 40px); max-width: 350px; }
            .mega-menu-panel { padding: 15px; }
            .mega-menu-column { min-width: calc(50% - 20px); }
            .mega-menu-column:not(:last-child) { border-right: none; }
            
            .proconcursos-questoes-container {
                right: 20px;
                bottom: 20px;
            }
            .proconcursos-questoes-btn {
                padding: 12px 24px;
                font-size: 1em;
            }
        }
        @media screen and (max-width: 480px) {
            #floatingToolsPanel { bottom: 10px; right: 10px; width: calc(100% - 20px); }
            /* .tool-buttons button { font-size: 0.85em; padding: 6px 8px; } */ /* Se houver .tool-buttons */
            .mega-menu-column { min-width: 100%; padding: 0; }

            .proconcursos-questoes-container {
                right: 15px;
                bottom: 15px;
            }
            .proconcursos-questoes-btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div id="megaMenuContainer">
        <div class="mega-menu-panel" id="cursos-menu">
            <div class="mega-menu-column">
                <h4>Direito</h4>
                <a href="#">Direito Constitucional</a>
                <a href="#">Direito Administrativo</a>
                <a href="#">Direito Penal</a>
                <a href="#">Direito Civil</a>
            </div>
            <div class="mega-menu-column">
                <h4>Matem√°tica</h4>
                <a href="#">Matem√°tica B√°sica</a>
                <a href="#">Racioc√≠nio L√≥gico</a>
                <a href="#">Estat√≠stica</a>
                <a href="#">Matem√°tica Financeira</a>
            </div>
            <div class="mega-menu-column">
                <h4>Portugu√™s</h4>
                <a href="#">Gram√°tica</a>
                <a href="#">Interpreta√ß√£o de Texto</a>
                <a href="#">Reda√ß√£o Oficial</a>
                <a href="#">Literatura</a>
            </div>
            <div class="mega-menu-column">
                <h4>Inform√°tica</h4>
                <a href="#">Inform√°tica B√°sica</a>
                <a href="#">Sistemas Operacionais</a>
                <a href="#">Redes de Computadores</a>
                <a href="#">Seguran√ßa da Informa√ß√£o</a>
            </div>
        </div>
        <div class="mega-menu-panel" id="questoes-menu">
            <div class="mega-menu-column">
                <h4>Por Disciplina</h4>
                <a href="#">Direito Constitucional</a>
                <a href="#">Matem√°tica B√°sica</a>
                <a href="#">Portugu√™s</a>
                <a href="#">Inform√°tica</a>
            </div>
            <div class="mega-menu-column">
                <h4>Por Concurso</h4>
                <a href="#">Pol√≠cia Federal</a>
                <a href="#">INSS</a>
                <a href="#">Receita Federal</a>
                <a href="#">Tribunais</a>
            </div>
        </div>
        <div class="mega-menu-panel" id="flashcards-menu">
            <div class="mega-menu-column">
                <h4>Por Disciplina</h4>
                <a href="#">Direito Constitucional</a>
                <a href="#">Matem√°tica B√°sica</a>
                <a href="#">Portugu√™s</a>
                <a href="#">Inform√°tica</a>
            </div>
            <div class="mega-menu-column">
                <h4>Por Concurso</h4>
                <a href="#">Pol√≠cia Federal</a>
                <a href="#">INSS</a>
                <a href="#">Receita Federal</a>
                <a href="#">Tribunais</a>
            </div>
        </div>
    </div>

    <div class="content-wrapper">
        <nav class="sidebar" id="sidebar">
            <h2>
                Meus Cursos
            </h2>
            <div class="sidebar-nav" id="courseMenu">
                <p>Carregando cursos...</p>
            </div>
        </nav>

        <main id="mainContent">
            <div class="container">
                <div class="study-room-header">
                    <h1>Sala de Estudos</h1>
                    <p>Acesse os conte√∫dos que voc√™ selecionou para estudar de forma organizada.</p>
                </div>
                <div id="lessonContent">
                    <p>Selecione uma aula no menu √† esquerda para come√ßar.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="floatingToolsPanel" style="display:none;">
        </div>

    <div id="proConcursosQuestoesContainer" class="proconcursos-questoes-container">
        <button id="proConcursosQuestoesBtn" class="proconcursos-questoes-btn">
            QUEST√ïES
        </button>
    </div>
    
    <script src="questoes-injector.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        class SalaDeEstudosApp {
            constructor() {
                // 1. Configura√ß√£o Inicial
                this.firebaseConfig = {
                    apiKey: "AIzaSyD103GQaVxUfLuH-ySnCxu7rl0xE8noaJM", // Substitua pela sua chave real
                    authDomain: "nvp-concursos.firebaseapp.com",
                    projectId: "nvp-concursos",
                    storageBucket: "nvp-concursos.firebasestorage.app",
                    messagingSenderId: "397960760271",
                    appId: "1:397960760271:web:1550ff01910ae927d860ba"
                };
                
                // 2. Estado da Aplica√ß√£o
                this.userId = null;
                this.db = null;
                this.auth = null;
                this.loadedCoursesData = [];
                this.activeLesson = { courseId: null, moduleId: null, subtopicId: null };

                // 3. Cache de Elementos DOM
                this.elements = {};

                // 4. Inicia o ciclo de vida
                this.init();
            }

            async init() {
                console.log("üöÄ Inicializando Sala de Estudos App...");
                this.cacheDomElements();
                this.initFirebase();
                await this.loadHeader(); // Carrega o header e DEPOIS inicializa seus eventos
                this.setupStaticEventListeners();
                this.setupAuthentication();
            }

            async loadHeader() {
                try {
                    const response = await fetch('header_saladeestudos.html');
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar o header: ${response.status}`);
                    }
                    this.elements.headerPlaceholder.innerHTML = await response.text();
                    this.setupHeaderEventListeners(); // Chama os eventos AP√ìS o conte√∫do existir
                    
                    // Inicializa o Pomodoro se existir
                    if (window.PomodoroTimerApp && typeof window.PomodoroTimerApp.init === 'function') {
                        window.PomodoroTimerApp.init();
                    }

                } catch (error) {
                    console.error(error);
                    this.elements.headerPlaceholder.innerHTML = `
                        <div style="background-color: #f8d7da; color: #721c24; padding: 1rem; text-align: center;">
                            <strong>Erro Cr√≠tico:</strong> N√£o foi poss√≠vel carregar o cabe√ßalho da p√°gina.
                        </div>
                    `;
                }
            }

            cacheDomElements() {
                this.elements = {
                    headerPlaceholder: document.getElementById('header-placeholder'),
                    sidebar: document.getElementById('sidebar'),
                    mainContent: document.getElementById('mainContent'),
                    courseMenuContainer: document.getElementById('courseMenu'),
                    lessonContentDiv: document.getElementById('lessonContent'),
                    body: document.body
                    // Adicione outros elementos est√°ticos aqui
                };
            }

            setupStaticEventListeners() {
                // Eventos que n√£o dependem de conte√∫do din√¢mico
                window.addEventListener('resize', this.updateLayout.bind(this));
            }

            setupHeaderEventListeners() {
                const headerPlaceholder = this.elements.headerPlaceholder;
                if (!headerPlaceholder) return;

                // 1. Bot√£o da Sidebar
                const sidebarToggleBtn = headerPlaceholder.querySelector('#sidebarToggleBtn');
                if (sidebarToggleBtn) {
                    sidebarToggleBtn.addEventListener('click', this.toggleSidebar.bind(this));
                }

                // 2. Bot√£o de Tema
                const themeToggleBtn = headerPlaceholder.querySelector('#themeToggleBtn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', this.toggleTheme.bind(this));
                }

                // 3. Bot√£o de Logout
                const logoutBtn = headerPlaceholder.querySelector('#logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.auth.signOut();
                    });
                }

                // 4. L√≥gica dos Menus Dropdown (antigo Mega Menu)
                const navButtons = headerPlaceholder.querySelectorAll('.nav-button');
                const dropdownMenus = document.querySelectorAll('.mega-menu-panel'); // Os pain√©is est√£o no corpo principal

                navButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const targetMenuId = button.dataset.target;
                        const targetMenu = document.getElementById(targetMenuId);

                        // Fecha outros menus que possam estar abertos
                        dropdownMenus.forEach(menu => {
                            if (menu.id !== targetMenuId) {
                                menu.classList.remove('active');
                            }
                        });
                        navButtons.forEach(btn => {
                            if (btn !== button) {
                                btn.classList.remove('active');
                            }
                        });

                        // Alterna o menu e bot√£o atuais
                        if (targetMenu) {
                            targetMenu.classList.toggle('active');
                            button.classList.toggle('active');
                        }
                    });
                });

                // Fecha todos os menus se o usu√°rio clicar fora deles
                window.addEventListener('click', (event) => {
                    const isClickInsideHeader = headerPlaceholder.contains(event.target);
                    if (!isClickInsideHeader) {
                        dropdownMenus.forEach(menu => menu.classList.remove('active'));
                        navButtons.forEach(btn => btn.classList.remove('active'));
                    }
                });
            }

            updateLayout() {
                // A maior parte do layout √© tratada por CSS, mas podemos adicionar l√≥gica JS se necess√°rio.
                // Por exemplo, fechar a sidebar em telas menores ao redimensionar.
                if (window.innerWidth <= 768) {
                    this.elements.sidebar.classList.add('hidden');
                    this.elements.mainContent.classList.add('sidebar-hidden');
                }
            }

            toggleSidebar() {
                const isHidden = this.elements.sidebar.classList.toggle('hidden');
                this.elements.mainContent.classList.toggle('sidebar-hidden', isHidden);
                // Em telas pequenas, a sidebar deve ser vis√≠vel sobre o conte√∫do
                if (window.innerWidth <= 768) {
                    this.elements.sidebar.classList.toggle('visible', !isHidden);
                }
            }

            toggleTheme() {
                const isDark = this.elements.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                }
            }

            initFirebase() {
                if (!firebase.apps.length) {
                    firebase.initializeApp(this.firebaseConfig);
                }
                this.auth = firebase.auth();
                this.db = firebase.firestore();
            }

            setupAuthentication() {
                this.elements.lessonContentDiv.innerHTML = '<p>Verificando autentica√ß√£o...</p>';

                // Etapa 1: Verifica√ß√£o s√≠ncrona imediata
                const currentUser = this.auth.currentUser;
                if (currentUser) {
                    console.log("Usu√°rio encontrado via verifica√ß√£o s√≠ncrona. Prosseguindo...");
                    this.initializeUserSession(currentUser);
                    return; // Autentica√ß√£o bem-sucedida, n√£o precisa do listener.
                }

                // Etapa 2: Se a verifica√ß√£o s√≠ncrona falhar, usa o listener ass√≠ncrono.
                console.log("Verifica√ß√£o s√≠ncrona falhou. Aguardando listener onAuthStateChanged...");
                const unsubscribe = this.auth.onAuthStateChanged(user => {
                    unsubscribe(); // S√≥ precisamos do primeiro resultado.
                    if (user) {
                        console.log("Usu√°rio encontrado via listener onAuthStateChanged. Prosseguindo...");
                        this.initializeUserSession(user);
                    } else {
                        console.log("Listener confirmou que n√£o h√° usu√°rio. Redirecionando para login.");
                        this.redirectToLogin();
                    }
                });
            }

            initializeUserSession(user) {
                this.userId = user.uid;
                console.log("Sess√£o do usu√°rio inicializada:", this.userId);
                this.applyUserPreferences();
                this.loadCourses();
                this.initExternalModules();
            }

            redirectToLogin() {
                this.elements.lessonContentDiv.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 2rem;">
                        <h3>‚ö†Ô∏è Acesso Negado</h3>
                        <p>Voc√™ precisa estar logado para acessar esta p√°gina. Redirecionando...</p>
                        <a href="index.html" style="display: inline-block; margin-top: 1rem; padding: 0.8rem 1.5rem; background-color: var(--main-color); color: white; text-decoration: none; border-radius: 5px;">Ir para a p√°gina de Login</a>
                    </div>
                `;
                this.elements.courseMenuContainer.innerHTML = '<p>Fa√ßa login para ver seus cursos.</p>';
                
                // Define uma flag para o index.html saber que viemos de uma p√°gina interna.
                sessionStorage.setItem('auth_redirect_loop_prevention', Date.now().toString());

                setTimeout(() => {
                   window.location.href = 'index.html';
                }, 2000);
            }


            applyUserPreferences() {
                const savedTheme = localStorage.getItem('theme');
                // Se n√£o houver tema salvo, usa a prefer√™ncia do sistema operacional como padr√£o
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

                this.elements.body.classList.toggle('dark-mode', isDark);

                // A atualiza√ß√£o do √≠cone do tema √© feita em setupHeaderEventListeners, 
                // que √© chamado depois que o header √© carregado.
            }

            async loadCourses() {
                if (!this.userId) {
                    this.elements.courseMenuContainer.innerHTML = '<p>Erro: Usu√°rio n√£o identificado.</p>';
                    return;
                }
                this.elements.courseMenuContainer.innerHTML = '<p>Carregando seus cursos...</p>';
                
                try {
                    const userDoc = await this.db.collection('users').doc(this.userId).get();
                    let coursesToDisplay = [];

                    if (userDoc.exists && userDoc.data().hasPersonalized && userDoc.data().selectedSubtopics?.length > 0) {
                        console.log("Carregando plano de estudos personalizado...");
                        coursesToDisplay = await this._loadPersonalizedCourses(userDoc.data().selectedSubtopics);
                    } else {
                        console.log("Carregando todos os cursos dispon√≠veis...");
                        coursesToDisplay = await this._loadAllCourses();
                    }

                    if (coursesToDisplay.length === 0) {
                        this.elements.courseMenuContainer.innerHTML = '<p>Nenhum curso dispon√≠vel para voc√™ no momento.</p>';
                        return;
                    }

                    this.loadedCoursesData = coursesToDisplay;
                    this.renderCourseMenu();

                } catch (error) {
                    console.error('Erro cr√≠tico ao carregar cursos:', error);
                    this.elements.courseMenuContainer.innerHTML = `<p style="padding: 10px; color: var(--error-color);">Erro ao carregar cursos. Tente recarregar a p√°gina.</p>`;
                }
            }

            async _loadPersonalizedCourses(selectedSubtopicsInfo) {
                const structuredSelections = {};
                for (const selection of selectedSubtopicsInfo) {
                    if (!structuredSelections[selection.courseId]) {
                        structuredSelections[selection.courseId] = {};
                    }
                    if (!structuredSelections[selection.courseId][selection.moduleId]) {
                        structuredSelections[selection.courseId][selection.moduleId] = [];
                    }
                    structuredSelections[selection.courseId][selection.moduleId].push(selection.subtopicId);
                }

                const coursesToDisplay = [];
                for (const courseId in structuredSelections) {
                    const courseRef = this.db.collection('courses').doc(courseId);
                    const courseDoc = await courseRef.get();
                    if (!courseDoc.exists) { console.warn(`Curso ${courseId} n√£o encontrado.`); continue; }
                    
                    const courseData = courseDoc.data();
                    const courseEntry = { id: courseId, name: courseData.name || 'Curso s/ Nome', order: courseData.order || 0, modules: [] };

                    for (const moduleId in structuredSelections[courseId]) {
                        const moduleRef = courseRef.collection('modules').doc(moduleId);
                        const moduleDoc = await moduleRef.get();
                        if (!moduleDoc.exists) { console.warn(`M√≥dulo ${moduleId} n√£o encontrado.`); continue; }

                        const moduleData = moduleDoc.data();
                        const moduleEntry = { id: moduleId, name: moduleData.name || 'M√≥dulo s/ Nome', order: moduleData.order || 0, subtopics: [] };

                        for (const subtopicId of structuredSelections[courseId][moduleId]) {
                            const subtopicRef = moduleRef.collection('subtopics').doc(subtopicId);
                            const subtopicDoc = await subtopicRef.get();
                            if (subtopicDoc.exists) {
                                moduleEntry.subtopics.push({ id: subtopicId, ...subtopicDoc.data() });
                            } else {
                                console.warn(`Subtema ${subtopicId} n√£o encontrado.`);
                            }
                        }

                        if (moduleEntry.subtopics.length > 0) {
                            moduleEntry.subtopics.sort((a, b) => a.order - b.order);
                            courseEntry.modules.push(moduleEntry);
                        }
                    }

                    if (courseEntry.modules.length > 0) {
                        courseEntry.modules.sort((a, b) => a.order - b.order);
                        coursesToDisplay.push(courseEntry);
                    }
                }
                
                coursesToDisplay.sort((a, b) => a.order - b.order);
                return coursesToDisplay;
            }

            async _loadAllCourses() {
                const coursesToDisplay = [];
                const coursesSnapshot = await this.db.collection('courses').orderBy('order').get();
                
                if (coursesSnapshot.empty) return [];

                for (const courseDoc of coursesSnapshot.docs) {
                    const courseData = courseDoc.data();
                    const modulesSnapshot = await courseDoc.ref.collection('modules').orderBy('order').get();
                    const modules = [];

                    for (const moduleDoc of modulesSnapshot.docs) {
                        const moduleData = moduleDoc.data();
                        const subtopicsSnapshot = await moduleDoc.ref.collection('subtopics').orderBy('order').get();
                        const subtopics = subtopicsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        if (subtopics.length > 0) {
                            modules.push({ id: moduleDoc.id, ...moduleData, subtopics });
                        }
                    }
                    
                    if (modules.length > 0) {
                        coursesToDisplay.push({ id: courseDoc.id, ...courseData, modules });
                    }
                }
                return coursesToDisplay;
            }


            renderCourseMenu() {
                if (!this.elements.courseMenuContainer) return;

                const fragment = document.createDocumentFragment();
                this.loadedCoursesData.forEach(course => {
                    const courseItem = document.createElement('div');
                    courseItem.className = 'course-item';

                    const courseHeader = document.createElement('div');
                    courseHeader.className = 'course-header';
                    courseHeader.dataset.courseId = course.id;
                    courseHeader.innerHTML = `<span>${course.name || 'Curso Sem Nome'}</span><span class="toggle-icon">‚ñ∂</span>`;

                    const moduleList = document.createElement('ul');
                    moduleList.className = 'module-list';
                    moduleList.id = `modules-${course.id}`;

                    (course.modules || []).forEach(module => {
                        const moduleItem = document.createElement('li');
                        moduleItem.className = 'module-item';

                        const moduleHeader = document.createElement('div');
                        moduleHeader.className = 'module-header';
                        moduleHeader.dataset.moduleId = module.id;
                        moduleHeader.innerHTML = `<span>${module.name || 'M√≥dulo Sem Nome'}</span><span class="toggle-icon">‚ñ∂</span>`;

                        const subtopicList = document.createElement('ul');
                        subtopicList.className = 'subtopic-list';
                        subtopicList.id = `subtopics-${module.id}`;

                        (module.subtopics || []).forEach(subtopic => {
                            const subtopicItem = document.createElement('li');
                            subtopicItem.className = 'subtopic-item';
                            
                            const link = document.createElement('a');
                            link.href = '#';
                            link.className = 'subtopic-link';
                            link.dataset.subtopicId = subtopic.id;
                            link.dataset.moduleId = module.id;
                            link.dataset.courseId = course.id;
                            link.textContent = subtopic.name || 'Aula Sem Nome';

                            subtopicItem.appendChild(link);
                            subtopicList.appendChild(subtopicItem);
                        });

                        moduleItem.appendChild(moduleHeader);
                        moduleItem.appendChild(subtopicList);
                        moduleList.appendChild(moduleItem);
                    });

                    courseItem.appendChild(courseHeader);
                    courseItem.appendChild(moduleList);
                    fragment.appendChild(courseItem);
                });

                this.elements.courseMenuContainer.innerHTML = ''; // Limpa o container
                if (fragment.hasChildNodes()) {
                    this.elements.courseMenuContainer.appendChild(fragment);
                } else {
                    this.elements.courseMenuContainer.innerHTML = '<p>Nenhum curso para exibir.</p>';
                }
                
                this._setupMenuInteraction();
            }

            _setupMenuInteraction() {
                if (!this.elements.courseMenuContainer) return;

                // Remove listener antigo para evitar duplicatas se este m√©todo for chamado novamente
                if (this._menuClickListener) {
                    this.elements.courseMenuContainer.removeEventListener('click', this._menuClickListener);
                }

                this._menuClickListener = (event) => {
                    const courseHeader = event.target.closest('.course-header');
                    const moduleHeader = event.target.closest('.module-header');
                    const subtopicLink = event.target.closest('.subtopic-link');

                    if (courseHeader) {
                        const moduleList = courseHeader.nextElementSibling;
                        const toggleIcon = courseHeader.querySelector('.toggle-icon');
                        moduleList.classList.toggle('visible');
                        toggleIcon.classList.toggle('expanded');
                        toggleIcon.textContent = toggleIcon.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
                        return; // Evita que o clique se propague para outros handlers
                    }

                    if (moduleHeader) {
                        const subtopicList = moduleHeader.nextElementSibling;
                        const toggleIcon = moduleHeader.querySelector('.toggle-icon');
                        subtopicList.classList.toggle('visible');
                        toggleIcon.classList.toggle('expanded');
                        toggleIcon.textContent = toggleIcon.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
                        return;
                    }

                    if (subtopicLink) {
                        event.preventDefault();
                        this.elements.courseMenuContainer.querySelectorAll('.subtopic-link.active').forEach(l => l.classList.remove('active'));
                        subtopicLink.classList.add('active');
                        const { subtopicId, moduleId, courseId } = subtopicLink.dataset;
                        this.loadLessonContent(courseId, moduleId, subtopicId);
                        return;
                    }
                };

                this.elements.courseMenuContainer.addEventListener('click', this._menuClickListener);
            }

            async loadLessonContent(courseId, moduleId, subtopicId) {
                this.elements.lessonContentDiv.innerHTML = '<p>Carregando aula...</p>';
                try {
                    const course = this.loadedCoursesData.find(c => c.id === courseId);
                    const module = course?.modules.find(m => m.id === moduleId);
                    const subtopic = module?.subtopics.find(s => s.id === subtopicId);

                    if (!subtopic || !subtopic.content_url) {
                        throw new Error("URL do conte√∫do n√£o encontrada para esta aula.");
                    }
                    
                    const response = await fetch(subtopic.content_url);
                    if (!response.ok) {
                        throw new Error(`N√£o foi poss√≠vel encontrar o material (Erro ${response.status}).`);
                    }

                    this.elements.lessonContentDiv.innerHTML = await response.text();
                    this.activeLesson = { courseId, moduleId, subtopicId };
                    
                    this.notifyExternalModules('lessonChanged');

                } catch (error) {
                    console.error('Erro ao carregar conte√∫do da aula:', error);
                    this.elements.lessonContentDiv.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <h3>‚ö†Ô∏è Erro ao Carregar a Aula</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }

            initExternalModules() {
                // Configura o bot√£o principal de quest√µes, que j√° est√° no HTML
                const questoesBtn = document.getElementById('proConcursosQuestoesBtn');
                if (questoesBtn) {
                    questoesBtn.addEventListener('click', () => {
                        if (window.toggleQuestoesAppGlobal) {
                            window.toggleQuestoesAppGlobal(); // Aciona a abertura/fechamento
                            this.notifyExternalModules('lessonChanged'); // Envia os dados da aula atual
                        } else {
                            alert('O m√≥dulo de quest√µes n√£o est√° dispon√≠vel no momento.');
                        }
                    });
                }
            }

            notifyExternalModules(eventType) {
                if (eventType === 'lessonChanged') {
                    const questoesIframe = document.getElementById('questoes-app-iframe');
                    if (questoesIframe && questoesIframe.contentWindow && this.activeLesson.subtopicId) {
                        // Atraso para garantir que o iframe esteja pronto para receber a mensagem
                        setTimeout(() => {
                            questoesIframe.contentWindow.postMessage({
                                type: 'loadQuestions',
                                subtopicId: this.activeLesson.subtopicId,
                                userId: this.userId
                            }, '*');
                            console.log('Dados da aula enviados ao m√≥dulo de quest√µes.');
                        }, 500);
                    }
                }
            }

            // ... outros m√©todos ser√£o adicionados aqui
        }

        // Instancia a aplica√ß√£o ap√≥s o DOM estar pronto
        document.addEventListener('DOMContentLoaded', () => new SalaDeEstudosApp());
    </script>
</body>
</html>
